<!doctype html>
<html lang="es" data-theme="light">
<head>
    <%- include('partials/head', {
    title: 'Admin horarios',
    description: 'Panel para administrar horarios y salidas.',
    noindex: true
    }) %>

    <style>
        .page-title{ letter-spacing:-.02em; font-weight:650; margin:0; }
        .subtle{ color: var(--muted); }

        .card-soft{
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            border-radius: 18px;
        }

        .toolbar{
            display:flex; gap:10px; flex-wrap:wrap;
            align-items:end; justify-content:space-between;
            margin-bottom: 14px;
        }

        .controls{
            display:flex; gap:10px; flex-wrap:wrap;
            align-items:end;
        }

        .form-label{ font-weight:600; }

        .slots-wrap{
            border:1px solid var(--border);
            border-radius:18px;
            padding: 14px;
            background: color-mix(in srgb, var(--card) 90%, transparent);
        }

        .pill{
            display:inline-flex; align-items:center; gap:.5rem;
            padding:.40rem .7rem; border-radius:999px;
            border:1px solid var(--border);
            background: var(--chip-bg);
            color: var(--chip-text);
            font-weight:650;
            font-size:.92rem;
            white-space:nowrap;
        }

        .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

        .mini{
            display:inline-flex; align-items:center; gap:.35rem;
            padding:.18rem .5rem; border-radius:999px;
            border:1px solid var(--border);
            background: color-mix(in srgb, var(--card) 86%, transparent);
            color: var(--muted);
            font-size:.82rem;
            white-space:nowrap;
        }

        .kpi{ display:flex; gap:8px; flex-wrap:wrap; }

        .tag-ok{ background: rgba(25,135,84,.12); color: color-mix(in srgb, #198754 70%, var(--text)); }
        .tag-warn{ background: rgba(241,220,33,.14); color: color-mix(in srgb, #f1dc21 60%, var(--text)); }
        .tag-bad{ background: rgba(220,53,69,.12); color: color-mix(in srgb, #dc3545 70%, var(--text)); }

        .switch{
            display:inline-flex; align-items:center; gap:8px;
            user-select:none;
        }
        .switch input{ width: 44px; height: 24px; }

        .actions{
            display:flex; gap:10px; flex-wrap:wrap;
            align-items:center;
            justify-content:flex-end;
            min-width: 250px;
        }

        .btn-mini{
            padding: .45rem .7rem;
            border-radius: 999px;
            border:1px solid var(--border);
            background: color-mix(in srgb, var(--card) 92%, transparent);
            color: var(--text);
            font-weight:650;
        }
        .btn-mini:hover{
            border-color: color-mix(in srgb, var(--wine) 45%, var(--border));
            background: color-mix(in srgb, var(--card) 78%, transparent);
        }

        .muted{ color: var(--muted); font-size:.92rem; }

        /* Tabs */
        .tabs{
            display:flex; gap:10px; flex-wrap:wrap;
            align-items:center;
        }
        .tabbtn{
            border:1px solid var(--border);
            background: color-mix(in srgb, var(--card) 92%, transparent);
            color: var(--text);
            border-radius: 999px;
            padding: .45rem .8rem;
            font-weight: 650;
            line-height: 1;
            display:inline-flex;
            align-items:center;
            gap:.5rem;
            user-select:none;
        }
        .tabbtn:hover{
            border-color: color-mix(in srgb, var(--wine) 45%, var(--border));
            background: color-mix(in srgb, var(--card) 78%, transparent);
        }
        .tabbtn.is-active{
            border-color: color-mix(in srgb, var(--wine) 70%, var(--border));
            background: color-mix(in srgb, var(--chip-bg) 70%, var(--card));
            box-shadow: 0 10px 26px rgba(2, 6, 23, .10);
        }
        .badge{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            min-width: 24px;
            height: 20px;
            padding: 0 .45rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 86%, transparent);
            font-size: .82rem;
            color: var(--muted);
        }

        /* Ops layout 2 columnas */
        .ops-grid {
            margin-top: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: start;
        }

        .ops-col {
            border: 1px solid color-mix(in srgb, var(--border) 85%, transparent);
            border-radius: 16px;
            background: color-mix(in srgb, var(--card) 94%, transparent);
            padding: 10px;
        }

        .ops-col-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 4px 6px 10px;
        }

        .ops-col-title {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .ops-list {
            margin-top: 2px;
        }

        .slot-row {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 16px;
            background: color-mix(in srgb, var(--card) 92%, transparent);
            margin-top: 10px;
        }

        .slot-left {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            min-width: 240px;
        }

        .disabled-row {
            opacity: .62;
        }

        /* Estado CANCELLED por d√≠a (visual r√°pido) */
        .day-cancelled {
            opacity: .78;
            border-color: color-mix(in srgb, #dc3545 28%, var(--border));
            background: color-mix(in srgb, var(--card) 90%, rgba(220, 53, 69, .06));
        }

        .day-cancelled .pill.mono {
            color: color-mix(in srgb, #dc3545 75%, var(--text));
        }

        .group-date{
            margin-top: 14px;
            padding-top: 8px;
            border-top: 1px dashed color-mix(in srgb, var(--border) 70%, transparent);
        }
        .group-date:first-child{
            margin-top: 6px;
            padding-top: 0;
            border-top: none;
        }
        .group-title{
            display:flex; align-items:center; gap:10px; flex-wrap:wrap;
            margin: 6px 0 8px;
        }

        /* Small form row */
        .row-form{
            display:flex; gap:10px; flex-wrap:wrap; align-items:end;
            margin-top: 10px;
            padding: 10px;
            border:1px dashed color-mix(in srgb, var(--border) 80%, transparent);
            border-radius: 16px;
            background: color-mix(in srgb, var(--card) 94%, transparent);
        }
        .row-form .field{ min-width: 160px; }
        .row-form input, .row-form select{
            border:1px solid var(--border);
            border-radius: 12px;
            padding: .55rem .7rem;
            background: var(--card);
            color: var(--text);
        }
        .row-form input:focus, .row-form select:focus{
            outline:none;
            border-color: color-mix(in srgb, var(--wine) 55%, var(--border));
            box-shadow: 0 0 0 .25rem color-mix(in srgb, var(--wine) 18%, transparent);
        }

        /* =========================================================
           ‚úÖ MOBILE UPGRADE (Admin horarios)
        ========================================================= */
        @media (max-width: 576px){

            main.container.py-4{ padding-top: 14px !important; padding-bottom: 16px !important; }
            .card-soft.p-4{ padding: 14px !important; }

            .toolbar {
                align-items: stretch;
                gap: 12px;
            }

            .controls{
                width: 100%;
                display: grid;
                grid-template-columns: 1fr;
                gap: 10px;
                align-items: stretch;
            }

            #dateWrap,
            #directionWrap,
            #dateWrap .form-control,
            #direction,
            .controls .form-select,
            .controls .form-control{
                width: 100%;
            }

            #loadBtn{
                width: 100%;
                border-radius: 14px;
                padding: .6rem 1rem;
                font-weight: 700;
            }

            .tabs{
                width: 100%;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 8px;
                padding-bottom: 6px;
            }
            .tabs::-webkit-scrollbar{ height: 6px; }
            .tabs::-webkit-scrollbar-thumb{
                background: color-mix(in srgb, var(--border) 70%, transparent);
                border-radius: 999px;
            }

            .tabbtn{
                flex: 0 0 auto;
                white-space: nowrap;
                padding: .5rem .85rem;
                border-radius: 999px;
            }

            .slots-wrap{ padding: 12px; }

            .kpi .pill {
                font-size: .88rem;
                padding: .38rem .62rem;
            }

            .ops-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .slot-row{
                display: block;
                padding: 12px;
                border-radius: 16px;
            }

            .slot-left{
                min-width: auto;
                width: 100%;
                gap: 8px;
            }

            .pill {
                font-size: .88rem;
                padding: .38rem .62rem;
            }

            .mini {
                font-size: .82rem;
                padding: .18rem .5rem;
            }

            .actions{
                width: 100%;
                min-width: 0;
                margin-top: 10px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                justify-content: initial;
                align-items: center;
            }

            .actions .switch{
                width: 100%;
                justify-content: space-between;
                padding: .45rem .6rem;
                border: 1px dashed color-mix(in srgb, var(--border) 75%, transparent);
                border-radius: 14px;
                background: color-mix(in srgb, var(--card) 92%, transparent);
            }

            .actions .switch input{
                width: 44px;
                height: 24px;
                margin: 0;
            }

            .btn-mini{
                width: 100%;
                justify-content: center;
                padding: .55rem .85rem;
            }

            .row-form{
                display: grid;
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .row-form .field{ min-width: 0; }
            .row-form button.btn.btn-wine{ width: 100%; border-radius: 14px; }

            .group-title {
                gap: 8px;
            }
        }
    </style>
</head>

<body>
<nav class="navbar navbar-dark app-navbar">
    <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/admin/agenda">
            <span class="brand-dot"></span>
            <span class="fw-semibold">Admin ‚Ä¢ Horarios</span>
        </a>

        <div class="d-flex align-items-center gap-2">
            <a class="btn btn-outline-light btn-sm rounded-4" href="/admin/agenda">Volver</a>

            <form method="POST" action="/admin/logout" class="m-0">
                <button class="btn btn-sm btn-outline-light rounded-4">Salir</button>
            </form>
        </div>
    </div>
</nav>

<main class="container py-4">

    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
        <div>
            <h1 class="h3 page-title mb-1">Administraci√≥n completa de horarios</h1>
            <div class="subtle">Configuraci√≥n de horarios, desactivar por d√≠a y precios.</div>
        </div>
    </div>

    <div class="card-soft p-4">
        <div class="toolbar">
            <div class="controls">
                <div id="dateWrap">
                    <label class="form-label">Fecha</label>
                    <input id="trip_date" type="date" class="form-control"/>
                </div>

                <div id="directionWrap">
                    <label class="form-label">Direcci√≥n</label>
                    <select id="direction" class="form-select">
                        <option value="VIC_TO_LLE">Victoria ‚Üí Llera</option>
                        <option value="LLE_TO_VIC">Llera ‚Üí Victoria</option>
                    </select>
                </div>

                <button id="loadBtn" class="btn btn-wine" type="button">Cargar</button>
            </div>

            <div class="tabs" id="tabs">
                <button type="button" class="tabbtn is-active" data-tab="ops">
                    Operaci√≥n (por fecha) <span class="badge" id="bOps">‚Äî</span>
                </button>

                <button type="button" class="tabbtn" data-tab="disabled_day">
                    Desactivar por d√≠a <span class="badge" id="bDisabledDay">‚Äî</span>
                </button>

                <button type="button" class="tabbtn" data-tab="templates">
                    Configuraci√≥n de horarios <span class="badge" id="bTemplates">‚Äî</span>
                </button>

                <button type="button" class="tabbtn" data-tab="pricing">
                    Precios <span class="badge" id="bPricing">‚Äî</span>
                </button>
            </div>

            <div class="muted" id="statusText">‚Äî</div>
        </div>

        <div class="slots-wrap">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="kpi">
                    <span class="pill">üìÖ <span id="kDate">‚Äî</span></span>
                    <span class="pill">üß≠ <span id="kDir">‚Äî</span></span>
                </div>
                <div class="muted" id="hint">Selecciona pesta√±a.</div>
            </div>

            <div id="list"></div>
        </div>
    </div>

</main>

<%- include('partials/toast') %>
<%- include('partials/footer') %>

<script src="/js/theme.js"></script>

<script>
    const tripDateEl = document.getElementById("trip_date");
    const directionEl = document.getElementById("direction");
    const loadBtn = document.getElementById("loadBtn");
    const listEl = document.getElementById("list");

    const kDate = document.getElementById("kDate");
    const kDir = document.getElementById("kDir");
    const hint = document.getElementById("hint");
    const statusText = document.getElementById("statusText");
    const dateWrap = document.getElementById("dateWrap");
    const directionWrap = document.getElementById("directionWrap");

    const tabsEl = document.getElementById("tabs");
    const bOps = document.getElementById("bOps");
    const bDisabledDay = document.getElementById("bDisabledDay");
    const bTemplates = document.getElementById("bTemplates");
    const bPricing = document.getElementById("bPricing");

    let currentTab = "ops";

    function todayISO(){
        return new Date().toLocaleDateString("en-CA", { timeZone: "America/Monterrey" });
    }

    function addDaysISO(dateISO, days){
        const d = new Date(`${dateISO}T00:00:00`);
        d.setDate(d.getDate() + Number(days || 0));
        return d.toLocaleDateString("en-CA", { timeZone: "America/Monterrey" });
    }

    function dirLabel(d){
        return d === "VIC_TO_LLE" ? "Victoria ‚Üí Llera" : "Llera ‚Üí Victoria";
    }

    function tagByAvailability(avail){
        const n = Number(avail || 0);
        if (n <= 0) return "tag-bad";
        if (n <= 2) return "tag-warn";
        return "tag-ok";
    }

    function escapeHtml(s){
        return String(s || "").replace(/[&<>"']/g, m => ({
            "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
        }[m]));
    }

    async function apiGet(url){
        const res = await fetch(url);
        return res.json();
    }

    async function apiPost(url, body){
        const res = await fetch(url, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(body)
        });
        return res.json();
    }

    /* -----------------------------
       OPS (2 columnas)
    ----------------------------- */
    function opsRowTemplate(r) {
        const disabledBecauseTemplate = !r.template_active;
        const tripEnabled = (String(r.trip_status || "OPEN").toUpperCase() === "OPEN");
        const availTag = tagByAvailability(r.available);
        const dayCancelledClass = (!tripEnabled && !disabledBecauseTemplate) ? "day-cancelled" : "";

        return `
            <div class="slot-row ${disabledBecauseTemplate ? "disabled-row" : ""} ${dayCancelledClass}"
                 data-templateid="${r.template_id}"
                 data-direction="${escapeHtml(r.direction)}"
                 data-depart="${escapeHtml(r.depart_time)}"
                 data-capacity="${Number(r.capacity || 0)}"
                 data-used="${Number(r.used || 0)}">
                <div class="slot-left">
                    <span class="pill mono">üïí ${escapeHtml(r.depart_time)}</span>
                    <span class="mini">Cap: <strong>${r.capacity}</strong></span>
                    <span class="mini">Usados: <strong class="js-used">${r.used}</strong></span>
                    <span class="mini ${availTag}">Libres: <strong class="js-avail">${r.available}</strong></span>
                </div>

                <div class="actions">
                    <label class="switch" title="Desactivar por completo (horario base)">
                        <span class="muted">Completo</span>
                        <input class="template-toggle" type="checkbox" ${r.template_active ? "checked" : ""}>
                    </label>

                    <label class="switch" title="Desactivar por d√≠a (solo esta fecha)">
                        <span class="muted">D√≠a</span>
                        <input class="trip-toggle" type="checkbox"
                               ${tripEnabled ? "checked" : ""}
                               ${disabledBecauseTemplate ? "disabled" : ""}>
                    </label>
                </div>
            </div>
        `;
    }

    function bindOpsRow(rowEl, date) {
        const templateId = Number(rowEl.dataset.templateid);
        const rowDir = String(rowEl.dataset.direction || "");
        const depart = String(rowEl.dataset.depart || "");
        const capacity = Number(rowEl.dataset.capacity || 0);

        const templateToggle = rowEl.querySelector(".template-toggle");
        const tripToggle = rowEl.querySelector(".trip-toggle");

        templateToggle?.addEventListener("change", async () => {
            templateToggle.disabled = true;
            const active = templateToggle.checked;

            statusText.textContent = "Guardando (base)‚Ä¶";

            const r = await apiPost("/admin/api/templates/update", {
                id: templateId,
                direction: rowDir,
                depart_time: depart,
                capacity_passengers: capacity || 6,
                active: active ? 1 : 0
            });

            templateToggle.disabled = false;

            if (!r?.ok) {
                templateToggle.checked = !active;
                statusText.textContent = "‚Äî";
                notify("No pude actualizar el horario base.", {variant: "danger", delay: 2200});
                return;
            }

            statusText.textContent = "Actualizado.";
            notify("Horario base actualizado.", {variant: "success", delay: 1400});
            // aqu√≠ s√≠ recargamos tab para reflejar locks/disabled
            load();
        });

        // ‚úÖ Mejora 1 + 2: confirmaci√≥n inteligente + refrescar SOLO fila
        tripToggle?.addEventListener("change", async () => {
            const enabled = tripToggle.checked;

            // confirmaci√≥n inteligente al DESHABILITAR si hay usados
            if (!enabled) {
                const used = Number(rowEl.dataset.used || 0);
                if (used > 0) {
                    const ok = confirm(`Hay ${used} asiento(s) usados en este horario.\n\n¬øSeguro que deseas DESHABILITAR este d√≠a?`);
                    if (!ok) {
                        tripToggle.checked = true;
                        return;
                    }
                }
            }

            tripToggle.disabled = true;
            statusText.textContent = enabled ? "Habilitando‚Ä¶" : "Deshabilitando‚Ä¶";

            const resp = await apiPost("/admin/api/horarios/trip", {
                trip_date: date,
                template_id: templateId,
                enabled
            });

            tripToggle.disabled = false;

            if (!resp?.ok) {
                tripToggle.checked = !enabled;
                statusText.textContent = "‚Äî";
                notify("No pude actualizar el horario del d√≠a.", {variant: "danger", delay: 2200});
                return;
            }

            if (!enabled) {
                const c = Number(resp.cancelledReservations || 0);
                const p = Number(resp.rejectedPayments || 0);
                if (c || p) {
                    notify(`Deshabilitado. Cancel√© ${c} reserva(s) y rechac√© ${p} pago(s) pendiente(s).`, {
                        variant: "success",
                        delay: 2400
                    });
                } else {
                    notify("Deshabilitado para ese d√≠a.", {variant: "success", delay: 1600});
                }
            } else {
                notify("Habilitado para ese d√≠a.", {variant: "success", delay: 1600});
            }

            statusText.textContent = "Actualizado.";

            // refresco solo la fila (sin load completo)
            await refreshOpsRow(templateId, date, rowDir);
        });
    }

    async function refreshOpsRow(templateId, date, direction) {
        const data = await apiGet(`/admin/api/horarios?date=${encodeURIComponent(date)}&direction=${encodeURIComponent(direction)}`);
        if (!data?.ok) return;

        const rowData = (data.rows || []).find(x => Number(x.template_id) === Number(templateId));
        if (!rowData) return;

        const old = listEl.querySelector(`.slot-row[data-templateid="${templateId}"]`);
        if (!old) return;

        const tmp = document.createElement("div");
        tmp.innerHTML = opsRowTemplate(rowData);
        const fresh = tmp.firstElementChild;

        old.replaceWith(fresh);
        bindOpsRow(fresh, date);
    }

    async function loadOps() {
        const date = tripDateEl.value;

        // ops: uso ambas direcciones; oculto selector direcci√≥n
        directionWrap.style.display = "none";
        dateWrap.style.display = "";

        kDate.textContent = date || "‚Äî";
        kDir.textContent = "Ambas direcciones";

        if (!date) {
            hint.textContent = "Selecciona una fecha.";
            listEl.innerHTML = "";
            return;
        }

        hint.textContent = "Cargando‚Ä¶";
        statusText.textContent = "Consultando BD‚Ä¶";

        const [a, b] = await Promise.all([
            apiGet(`/admin/api/horarios?date=${encodeURIComponent(date)}&direction=${encodeURIComponent("VIC_TO_LLE")}`),
            apiGet(`/admin/api/horarios?date=${encodeURIComponent(date)}&direction=${encodeURIComponent("LLE_TO_VIC")}`)
        ]);

        if (!a?.ok || !b?.ok) {
            hint.textContent = "Error al cargar.";
            statusText.textContent = "‚Äî";
            listEl.innerHTML = "";
            return;
        }

        const left = a.rows || [];
        const right = b.rows || [];

        bOps.textContent = String(left.length + right.length);

        listEl.innerHTML = `
            <div class="ops-grid">
                <div class="ops-col">
                    <div class="ops-col-head">
                        <div class="ops-col-title">
                            <span class="pill">üöå Victoria ‚Üí Llera</span>
                            <span class="mini">Horarios: <strong>${left.length}</strong></span>
                        </div>
                        <span class="badge">${left.length}</span>
                    </div>
                    <div class="ops-list" id="opsLeft">
                        ${left.length ? left.map(opsRowTemplate).join("") : `<div class="muted mt-2">Sin horarios.</div>`}
                    </div>
                </div>

                <div class="ops-col">
                    <div class="ops-col-head">
                        <div class="ops-col-title">
                            <span class="pill">üöå Llera ‚Üí Victoria</span>
                            <span class="mini">Horarios: <strong>${right.length}</strong></span>
                        </div>
                        <span class="badge">${right.length}</span>
                    </div>
                    <div class="ops-list" id="opsRight">
                        ${right.length ? right.map(opsRowTemplate).join("") : `<div class="muted mt-2">Sin horarios.</div>`}
                    </div>
                </div>
            </div>
        `;

        hint.textContent = "Listo.";
        statusText.textContent = `${left.length + right.length} horario(s)`;

        // bind events
        listEl.querySelectorAll(".slot-row").forEach(row => bindOpsRow(row, date));
    }

    /* -----------------------------
       TAB: Desactivar por d√≠a (lista global)
    ----------------------------- */
    function disabledDayRowTemplate(r){
        const availTag = tagByAvailability(r.available);
        return `
            <div class="slot-row day-cancelled" data-templateid="${r.template_id}" data-tripdate="${escapeHtml(r.trip_date)}">
                <div class="slot-left">
                    <span class="pill">üìÖ <span class="mono">${escapeHtml(r.trip_date)}</span></span>
                    <span class="pill mono">üïí ${escapeHtml(r.depart_time)}</span>
                    <span class="mini">Cap: <strong>${r.capacity}</strong></span>
                    <span class="mini">Usados: <strong>${r.used}</strong></span>
                    <span class="mini ${availTag}">Libres: <strong>${r.available}</strong></span>
                </div>

                <div class="actions">
                    <button class="btn-mini enableBtn">Habilitar</button>
                </div>
            </div>
        `;
    }

    async function loadDisabledDay(){
        const direction = directionEl.value;

        directionWrap.style.display = "";
        dateWrap.style.display = "none";

        const from = todayISO();
        const to = addDaysISO(from, 60);

        kDate.textContent = `${from} ‚Üí ${to}`;
        kDir.textContent = dirLabel(direction);

        hint.textContent = "Cargando cancelados‚Ä¶";
        statusText.textContent = "Consultando BD‚Ä¶";

        const data = await apiGet(`/admin/api/horarios/disabled-days?direction=${encodeURIComponent(direction)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
        if (!data?.ok){
            hint.textContent = "Error al cargar.";
            statusText.textContent = "‚Äî";
            listEl.innerHTML = "";
            return;
        }

        const rows = data.rows || [];
        bDisabledDay.textContent = String(rows.length);

        if (!rows.length){
            listEl.innerHTML = `<div class="muted mt-3">No hay horarios desactivados por d√≠a en el rango.</div>`;
            hint.textContent = "Listo.";
            statusText.textContent = "0";
            return;
        }

        const map = new Map();
        rows.forEach(r => {
            if (!map.has(r.trip_date)) map.set(r.trip_date, []);
            map.get(r.trip_date).push(r);
        });

        const blocks = [];
        for (const [d, items] of map.entries()){
            blocks.push(`
                <div class="group-date">
                    <div class="group-title">
                        <span class="pill">üìÖ <span class="mono">${escapeHtml(d)}</span></span>
                        <span class="mini">Cancelados: <strong>${items.length}</strong></span>
                    </div>
                    ${items.map(disabledDayRowTemplate).join("")}
                </div>
            `);
        }

        listEl.innerHTML = blocks.join("");
        hint.textContent = "Listo.";
        statusText.textContent = `${rows.length} cancelado(s)`;

        listEl.querySelectorAll(".slot-row").forEach(row => {
            const templateId = Number(row.dataset.templateid);
            const tripDate = String(row.dataset.tripdate || "");
            const enableBtn = row.querySelector(".enableBtn");

            enableBtn?.addEventListener("click", async () => {
                enableBtn.disabled = true;
                statusText.textContent = "Habilitando‚Ä¶";

                const r = await apiPost("/admin/api/horarios/trip", {
                    trip_date: tripDate,
                    template_id: templateId,
                    enabled: true
                });

                enableBtn.disabled = false;

                if (!r?.ok){
                    statusText.textContent = "‚Äî";
                    notify("No pude habilitar.", {variant:"danger", delay:2200});
                    return;
                }

                statusText.textContent = "Actualizado.";
                notify("Horario habilitado.", {variant:"success", delay:1400});
                load();
            });
        });
    }

    /* -----------------------------
       TAB: Horarios base (CRUD)
    ----------------------------- */
    function templateRowTemplate(t){
        const active = Number(t.active) === 1;

        return `
            <div class="slot-row ${active ? "" : "disabled-row"}" data-id="${t.id}">
                <div class="slot-left">
                    <span class="pill mono">#${t.id}</span>
                    <span class="mini">Direcci√≥n: <strong>${escapeHtml(t.direction)}</strong></span>
                </div>

                <div class="actions" style="min-width: 420px;">
                    <span class="mini">Hora</span>
                    <input class="t-time" type="time" value="${escapeHtml(t.depart_time)}" style="min-width:140px;border:1px solid var(--border);border-radius:12px;padding:.55rem .7rem;background:var(--card);color:var(--text);">
                    <span class="mini">Cap (0‚Äì6)</span>
                    <input class="t-cap" type="number" min="0" max="6" value="${Number(t.capacity_passengers || 0)}" style="width:90px;border:1px solid var(--border);border-radius:12px;padding:.55rem .7rem;background:var(--card);color:var(--text);">

                    <label class="switch" title="Desactivar por completo">
                        <span class="muted">Activo</span>
                        <input class="t-active" type="checkbox" ${active ? "checked" : ""}>
                    </label>

                    <button class="btn-mini t-save">Guardar</button>
                    <button class="btn-mini t-disable">Desactivar</button>
                </div>
            </div>
        `;
    }

    async function loadTemplates(){
        const direction = directionEl.value;

        directionWrap.style.display = "";
        dateWrap.style.display = "none";

        kDate.textContent = "‚Äî";
        kDir.textContent = dirLabel(direction);

        hint.textContent = "Cargando horarios base‚Ä¶";
        statusText.textContent = "Consultando BD‚Ä¶";

        const data = await apiGet(`/admin/api/templates?direction=${encodeURIComponent(direction)}&includeInactive=1`);
        if (!data?.ok){
            hint.textContent = "Error al cargar.";
            statusText.textContent = "‚Äî";
            listEl.innerHTML = "";
            return;
        }

        const rows = data.rows || [];
        bTemplates.textContent = String(rows.length);

        const addForm = `
            <div class="row-form" id="addForm">
                <div class="field">
                    <div class="mini">Direcci√≥n</div>
                    <select id="addDirection">
                        <option value="VIC_TO_LLE" ${direction==="VIC_TO_LLE"?"selected":""}>Victoria ‚Üí Llera</option>
                        <option value="LLE_TO_VIC" ${direction==="LLE_TO_VIC"?"selected":""}>Llera ‚Üí Victoria</option>
                    </select>
                </div>
                <div class="field">
                    <div class="mini">Hora</div>
                    <input id="addTime" type="time" value="06:30">
                </div>
                <div class="field">
                    <div class="mini">Cap (0‚Äì6)</div>
                    <input id="addCap" type="number" min="0" max="6" value="6">
                </div>
                <div class="field">
                    <div class="mini">Activo</div>
                    <select id="addActive">
                        <option value="1" selected>S√≠</option>
                        <option value="0">No</option>
                    </select>
                </div>
                <button class="btn btn-wine" type="button" id="addBtn">Agregar</button>
                <div class="muted">Tip: esto crea un horario base nuevo para esa direcci√≥n.</div>
            </div>
        `;

        listEl.innerHTML = addForm + (rows.length ? rows.map(templateRowTemplate).join("") : `<div class="muted mt-3">A√∫n no hay horarios base.</div>`);

        hint.textContent = "Listo.";
        statusText.textContent = `${rows.length} base`;

        const addBtn = document.getElementById("addBtn");
        addBtn?.addEventListener("click", async () => {
            const dir = document.getElementById("addDirection").value;
            const time = document.getElementById("addTime").value;
            const cap = Number(document.getElementById("addCap").value || 0);
            const active = Number(document.getElementById("addActive").value || 1);

            addBtn.disabled = true;
            statusText.textContent = "Agregando‚Ä¶";

            const r = await apiPost("/admin/api/templates/create", {
                direction: dir,
                depart_time: time,
                capacity_passengers: cap,
                active
            });

            addBtn.disabled = false;

            if (!r?.ok){
                statusText.textContent = "‚Äî";
                notify(r?.message || "No pude agregar el horario.", {variant:"danger", delay:2300});
                return;
            }

            statusText.textContent = "Agregado.";
            notify("Horario base agregado.", {variant:"success", delay:1500});
            load();
        });

        listEl.querySelectorAll(".slot-row[data-id]").forEach(row => {
            const id = Number(row.dataset.id);
            const timeEl = row.querySelector(".t-time");
            const capEl = row.querySelector(".t-cap");
            const activeEl = row.querySelector(".t-active");
            const saveBtn = row.querySelector(".t-save");
            const disableBtn = row.querySelector(".t-disable");

            saveBtn?.addEventListener("click", async () => {
                saveBtn.disabled = true;
                statusText.textContent = "Guardando‚Ä¶";

                const r = await apiPost("/admin/api/templates/update", {
                    id,
                    direction: directionEl.value,
                    depart_time: timeEl.value,
                    capacity_passengers: Number(capEl.value || 0),
                    active: activeEl.checked ? 1 : 0
                });

                saveBtn.disabled = false;

                if (!r?.ok){
                    statusText.textContent = "‚Äî";
                    notify(r?.message || "No pude guardar.", {variant:"danger", delay:2300});
                    return;
                }

                statusText.textContent = "Actualizado.";
                notify("Horario base actualizado.", {variant:"success", delay:1500});
                load();
            });

            disableBtn?.addEventListener("click", async () => {
                disableBtn.disabled = true;
                statusText.textContent = "Desactivando‚Ä¶";

                const r = await apiPost("/admin/api/templates/disable", { id });

                disableBtn.disabled = false;

                if (!r?.ok){
                    statusText.textContent = "‚Äî";
                    notify("No pude desactivar.", {variant:"danger", delay:2300});
                    return;
                }

                statusText.textContent = "Desactivado.";
                notify("Horario base desactivado.", {variant:"success", delay:1500});
                load();
            });
        });
    }

    /* -----------------------------
       TAB: Precios
    ----------------------------- */
    async function loadPricing(){
        directionWrap.style.display = "";
        dateWrap.style.display = "none";

        kDate.textContent = "‚Äî";
        kDir.textContent = "‚Äî";

        hint.textContent = "Cargando precios‚Ä¶";
        statusText.textContent = "Consultando BD‚Ä¶";

        const data = await apiGet("/admin/api/pricing");
        if (!data?.ok){
            hint.textContent = "Error al cargar precios.";
            statusText.textContent = "‚Äî";
            listEl.innerHTML = "";
            return;
        }

        bPricing.textContent = "‚úì";

        const passenger = Number(data.passenger_price_mxn || 0).toFixed(2);
        const pkg = Number(data.package_price_mxn || 0).toFixed(2);
        const updated = data.updated_at ? String(data.updated_at) : "‚Äî";

        listEl.innerHTML = `
            <div class="row-form">
                <div class="field">
                    <div class="mini">Precio Pasajero (MXN)</div>
                    <input id="pPassenger" type="number" step="0.01" min="0" value="${passenger}">
                </div>
                <div class="field">
                    <div class="mini">Precio Paqueter√≠a (MXN)</div>
                    <input id="pPackage" type="number" step="0.01" min="0" value="${pkg}">
                </div>

                <button class="btn btn-wine" type="button" id="savePricingBtn">Guardar</button>
                <div class="muted">√öltima actualizaci√≥n: ${escapeHtml(updated)}</div>
            </div>

            <div class="muted mt-3">
                Nota: el backend debe usar estos precios como ‚Äúsource of truth‚Äù.
            </div>
        `;

        hint.textContent = "Listo.";
        statusText.textContent = "Precios";

        const btn = document.getElementById("savePricingBtn");
        btn?.addEventListener("click", async () => {
            btn.disabled = true;
            statusText.textContent = "Guardando precios‚Ä¶";

            const passengerPrice = Number(document.getElementById("pPassenger").value || 0);
            const packagePrice = Number(document.getElementById("pPackage").value || 0);

            const r = await apiPost("/admin/api/pricing", {
                passenger_price_mxn: passengerPrice,
                package_price_mxn: packagePrice
            });

            btn.disabled = false;

            if (!r?.ok){
                statusText.textContent = "‚Äî";
                notify("No pude guardar precios.", {variant:"danger", delay:2200});
                return;
            }

            statusText.textContent = "Precios guardados.";
            notify("Precios guardados.", {variant:"success", delay:1500});
            load();
        });
    }

    /* -----------------------------
       Router UI
    ----------------------------- */
    function setActiveTab(tab){
        currentTab = tab || "ops";
        tabsEl?.querySelectorAll(".tabbtn").forEach(btn => {
            btn.classList.toggle("is-active", btn.dataset.tab === currentTab);
        });
        load();
    }

    async function load(){
        if (currentTab === "ops") return loadOps();
        if (currentTab === "disabled_day") return loadDisabledDay();
        if (currentTab === "templates") return loadTemplates();
        if (currentTab === "pricing") return loadPricing();
        return loadOps();
    }

    tabsEl?.addEventListener("click", (e) => {
        const btn = e.target.closest(".tabbtn");
        if (!btn) return;
        setActiveTab(btn.dataset.tab);
    });

    // cambio de fecha => refresca ops
    tripDateEl?.addEventListener("change", () => {
        if (currentTab === "ops") load();
    });

    // direcci√≥n solo afecta tabs que la usan
    directionEl?.addEventListener("change", () => {
        if (currentTab !== "ops") load();
    });

    loadBtn?.addEventListener("click", load);

    if (!tripDateEl.value) tripDateEl.value = todayISO();
    kDate.textContent = tripDateEl.value;
    kDir.textContent = "Ambas direcciones";

    load();
</script>
</body>
</html>
