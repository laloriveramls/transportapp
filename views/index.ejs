<!doctype html>
<html lang="es" data-theme="light">
<head>
    <%- include('partials/head', {
    title: 'Servicio de Transporte | Victoria â†” Llera',
    description: 'Horarios, reservas y ubicaciÃ³n de salidas. 6 pasajeros Â· Servicios de paqueterÃ­a',
    canonicalUrl: 'https://serviciodetransportevic.com/'
    }) %>

    <style>
        .hero-min {
            border: 1px solid var(--border);
            border-radius: 22px;
            padding: 18px;
            background: radial-gradient(1200px 600px at 10% 0%, rgba(106, 15, 31, .18), transparent 55%),
            radial-gradient(900px 500px at 90% 10%, rgba(106, 15, 31, .08), transparent 60%);
        }

        .title { letter-spacing: -.02em; font-weight: 650; margin: 0; }

        .sub { color: var(--muted); margin-top: 6px; font-size: .95rem; }

        .hero-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }

        .btn-ghost { border: 1px solid var(--border); background: transparent; color: var(--text); }
        .btn-ghost:hover {
            border-color: color-mix(in srgb, var(--wine) 40%, var(--border));
            background: color-mix(in srgb, var(--card) 70%, transparent);
            color: var(--text);
        }

        .btn-wa { background: #25D366; border-color: #25D366; color: #fff; }
        .btn-wa:hover { background: #1fb85a; border-color: #1fb85a; color: #fff; }

        .tabs-card {
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            border-radius: 22px;
            padding: 12px;
            margin-top: 14px;
        }

        .tabs-card .nav-tabs { border-bottom: 1px solid var(--border); }

        .tabs-card .nav-tabs .nav-link {
            color: var(--muted);
            border: 0;
            border-bottom: 2px solid transparent;
            border-radius: 12px 12px 0 0;
            font-weight: 650;
            padding: .55rem .85rem;
        }

        .tabs-card .nav-tabs .nav-link:hover { color: var(--text); }

        .tabs-card .nav-tabs .nav-link.active {
            color: var(--text);
            background: transparent;
            border-bottom-color: var(--wine);
        }

        .tab-pane { padding: 14px 6px 4px; }

        .routes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        @media (max-width: 992px) { .routes { grid-template-columns: 1fr; } }

        .route-card {
            background: color-mix(in srgb, var(--card) 90%, transparent);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 14px;
        }

        .route-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .route-name { margin: 0; font-weight: 650; letter-spacing: -.01em; }
        .route-sub { color: var(--muted); font-size: .9rem; margin-top: 2px; }

        .chips { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }

        /* Chips ahora son links */
        .chip-time {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            padding: .52rem .78rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 92%, transparent);
            color: var(--text);
            font-weight: 600;
            font-size: .92rem;
            white-space: nowrap;
            text-decoration: none;
        }

        .chip-time:hover {
            border-color: color-mix(in srgb, var(--wine) 45%, var(--border));
            background: color-mix(in srgb, var(--card) 78%, transparent);
            color: var(--text);
            text-decoration: none;
        }

        .chip-time:focus-visible{
            outline: 3px solid color-mix(in srgb, var(--wine) 35%, transparent);
            outline-offset: 2px;
        }

        .map-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 992px) { .map-grid { grid-template-columns: 1fr; } }

        .map-card {
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 14px;
            background: color-mix(in srgb, var(--card) 90%, transparent);
        }

        .map-title { margin: 0 0 10px 0; font-weight: 650; letter-spacing: -.01em; }

        .map-frame {
            width: 100%;
            height: 240px;
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            background: color-mix(in srgb, var(--card) 92%, transparent);
        }

        .map-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

        .footer-cta { position: sticky; bottom: 14px; z-index: 5; }
        @media (min-width: 992px) { .footer-cta { position: static; } }

        .app-footer {
            margin-top: 18px;
            border-top: 1px solid var(--border);
            padding: 14px 0 18px;
            color: var(--muted);
            font-size: .92rem;
        }

        .footer-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }

        .footer-phone { display: inline-flex; align-items: center; gap: .5rem; }

        .footer-phone code {
            color: var(--text);
            background: color-mix(in srgb, var(--card) 86%, transparent);
            border: 1px solid var(--border);
            padding: .15rem .5rem;
            border-radius: 999px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: .9rem;
        }

        .hero-split{ display:flex; align-items:center; justify-content:space-between; gap: 18px; }

        .hero-left{ flex: 1 1 auto; min-width: 0; }
        .hero-right{ flex: 0 0 auto; display:flex; align-items:center; justify-content:flex-end; }

        .hero-logo-big{
            width: 280px;
            max-width: 34vw;
            height: auto;
            object-fit: contain;
            display:block; /* ayuda a centrar con margin auto */
        }

        /* ===== mÃ³vil: centrar LOGO ===== */
        @media (max-width: 992px){
            .hero-split{
                flex-direction:column;
                align-items:stretch;
            }
            .hero-right{
                width:100%;
                justify-content:center;
                margin-top: 10px;
                text-align:center;
            }
            .hero-logo-big{
                width: min(320px, 90%);
                max-width: 90%;
                margin: 0 auto; /* centrado real */
            }
        }

        /* ===== Admin hotspot sobre el LOGO ===== */
        .logo-wrap{
            position: relative;
            display: inline-block;
        }

        @media (max-width: 992px){
            .logo-wrap{ margin: 0 auto; }
        }

        .logo-wrap .admin-hotspot{
            position: absolute;
            inset: 0;
            width: auto;
            height: auto;
            border-radius: 18px;
            border: 0;
            background: transparent;
            opacity: 0;
            cursor: default;

            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }

        /* ===== PrÃ³ximas salidas ===== */
        .next-card{
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 14px;
            margin-bottom: 12px;

            background-color: color-mix(in srgb, var(--card) 92%, transparent);
            background-image: radial-gradient(900px 420px at 10% 0%, rgba(106, 15, 31, .10), transparent 55%);
            background-repeat: no-repeat;
        }

        .next-title{
            margin: 0 0 10px 0;
            font-weight: 650;
            letter-spacing: -.01em;
        }

        .next-grid{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 992px){
            .next-grid{ grid-template-columns: 1fr; }
        }

        .next-item{
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            background: color-mix(in srgb, var(--card) 92%, transparent);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 10px;
        }

        .next-meta{ min-width:0; }
        .next-route{ font-weight:650; margin:0; }
        .next-when{ color: var(--muted); font-size: .92rem; margin-top: 2px; }

        .next-pill{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding:.45rem .7rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 92%, transparent);
            font-weight: 650;
            white-space: nowrap;
        }

        .next-actions a{
            white-space:nowrap;
        }
    </style>
</head>

<body>
<nav class="navbar navbar-dark app-navbar">
    <div class="container d-flex justify-content-between align-items-center position-relative">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/">
            <span class="brand-dot" aria-hidden="true"></span>
            <span class="fw-bold">TransportApp</span>
        </a>

        <button id="themeToggle" class="theme-btn" type="button" aria-label="Cambiar tema">
            <span id="themeIcon">ðŸŒ™</span> <span class="d-none d-sm-inline">Tema</span>
        </button>
    </div>
</nav>

<main class="container py-4">

    <div class="hero-min hero-split">
        <div class="hero-left">
            <h1 class="h3 title">Servicio de Transporte</h1>
            <div class="sub">Victoria â†” Llera Â· Llera â†” Victoria Â· 6 pasajeros Â· Servicios de paqueterÃ­a</div>

            <div class="hero-actions">
                <a class="btn btn-wine" href="/reserve">Reservar</a>
                <a class="btn btn-wa" target="_blank"
                   href="https://wa.me/52<%= ('8344756376').replace(/\D/g, '') %>?text=<%= encodeURIComponent('Hola, quiero informaciÃ³n del servicio de transporte.') %>">
                    WhatsApp
                </a>
            </div>
        </div>

        <div class="hero-right">
            <div class="logo-wrap">
                <img class="hero-logo-big" src="/assets/logo.png" alt="Servicio de transporte">
                <button type="button" id="adminHotspot" class="admin-hotspot" aria-label="Admin (oculto)"></button>
            </div>
        </div>
    </div>

    <div class="tabs-card">
        <ul class="nav nav-tabs" id="homeTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-horarios" data-bs-toggle="tab" data-bs-target="#pane-horarios"
                        type="button" role="tab">
                    Horarios
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-mapa" data-bs-toggle="tab" data-bs-target="#pane-mapa" type="button"
                        role="tab">
                    Mapa
                </button>
            </li>
        </ul>

        <div class="tab-content" id="homeTabsContent">
            <div class="tab-pane fade show active" id="pane-horarios" role="tabpanel" aria-labelledby="tab-horarios">

                <!-- PrÃ³ximas salidas -->
                <div class="next-card" id="nextCard" style="display:none;">
                    <p class="next-title">PrÃ³ximas salidas</p>

                    <div class="next-grid">
                        <div class="next-item" id="nextV2L" style="display:none;">
                            <div class="next-meta">
                                <p class="next-route">Victoria â†’ Llera</p>
                                <div class="next-when" id="nextV2LWhen">â€”</div>
                            </div>

                            <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
                                <span class="next-pill" id="nextV2LTime">--:--</span>
                                <div class="next-actions">
                                    <a class="btn btn-wine btn-sm rounded-4" id="nextV2LLink" href="/reserve">Reservar</a>
                                </div>
                            </div>
                        </div>

                        <div class="next-item" id="nextL2V" style="display:none;">
                            <div class="next-meta">
                                <p class="next-route">Llera â†’ Victoria</p>
                                <div class="next-when" id="nextL2VWhen">â€”</div>
                            </div>

                            <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
                                <span class="next-pill" id="nextL2VTime">--:--</span>
                                <div class="next-actions">
                                    <a class="btn btn-wine btn-sm rounded-4" id="nextL2VLink" href="/reserve">Reservar</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="routes">

                    <div class="route-card">
                        <div class="route-head">
                            <div>
                                <p class="route-name">Victoria â†’ Llera</p>
                                <div class="route-sub">Salida desde Ciudad Victoria</div>
                            </div>
                            <a class="btn btn-ghost btn-sm rounded-4" href="/reserve">Ver cupo</a>
                        </div>

                        <div class="chips">
                            <% const v2l = templates.filter(t => t.direction === 'VIC_TO_LLE'); %>
                            <% v2l.forEach(t => { const hhmm = String(t.depart_time || '').slice(0, 5); %>
                            <a class="chip-time"
                               data-dir="VIC_TO_LLE"
                               data-time="<%= hhmm %>"
                               href="/reserve?dir=VIC_TO_LLE&time=<%= encodeURIComponent(hhmm) %>"><%= hhmm %></a>
                            <% }) %>

                            <% if (v2l.length === 0) { %>
                                <div class="subtle">Sin horarios.</div>
                            <% } %>
                        </div>
                    </div>

                    <div class="route-card">
                        <div class="route-head">
                            <div>
                                <p class="route-name">Llera â†’ Victoria</p>
                                <div class="route-sub">Salida desde Llera</div>
                            </div>
                            <a class="btn btn-ghost btn-sm rounded-4" href="/reserve">Ver cupo</a>
                        </div>

                        <div class="chips">
                            <% const l2v = templates.filter(t => t.direction === 'LLE_TO_VIC'); %>
                            <% l2v.forEach(t => { const hhmm = String(t.depart_time || '').slice(0, 5); %>
                            <a class="chip-time"
                               data-dir="LLE_TO_VIC"
                               data-time="<%= hhmm %>"
                               href="/reserve?dir=LLE_TO_VIC&time=<%= encodeURIComponent(hhmm) %>"><%= hhmm %></a>
                            <% }) %>

                            <% if (l2v.length === 0) { %>
                                <div class="subtle">Sin horarios.</div>
                            <% } %>
                        </div>
                    </div>

                </div>
            </div>

            <div class="tab-pane fade" id="pane-mapa" role="tabpanel" aria-labelledby="tab-mapa">
                <div class="map-grid">
                    <div class="map-card">
                        <p class="map-title">Salida Victoria</p>
                        <iframe class="map-frame" loading="lazy"
                                referrerpolicy="no-referrer-when-downgrade"
                                src="https://www.google.com/maps?q=23.737544,-99.130954&z=16&output=embed"></iframe>

                        <div class="map-actions">
                            <a class="btn btn-wine btn-sm rounded-4" target="_blank"
                               href="https://www.google.com/maps?q=23.737544,-99.130954">Abrir</a>
                            <a class="btn btn-ghost btn-sm rounded-4" target="_blank"
                               href="https://www.google.com/maps/dir/?api=1&destination=23.737544,-99.130954">CÃ³mo llegar</a>
                        </div>
                    </div>

                    <div class="map-card">
                        <p class="map-title">Salida Llera</p>
                        <iframe class="map-frame" loading="lazy"
                                referrerpolicy="no-referrer-when-downgrade"
                                src="https://www.google.com/maps?q=23.317522,-99.023979&z=16&output=embed"></iframe>

                        <div class="map-actions">
                            <a class="btn btn-wine btn-sm rounded-4" target="_blank"
                               href="https://www.google.com/maps?q=23.317522,-99.023979">Abrir</a>
                            <a class="btn btn-ghost btn-sm rounded-4" target="_blank"
                               href="https://www.google.com/maps/dir/?api=1&destination=23.317522,-99.023979">CÃ³mo llegar</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-cta mt-3">
        <a class="btn btn-wine w-100 py-3 fw-bold rounded-4" href="/reserve">Reservar ahora</a>
    </div>

    <footer class="app-footer">
        <div class="footer-row">
            <div class="footer-phone">
                <span>WhatsApp</span>
                <code>834 475 6376</code>
            </div>

            <div class="d-flex gap-2 flex-wrap">
                <a class="btn btn-wa btn-sm" target="_blank"
                   href="https://wa.me/52<%= ('8344756376').replace(/\D/g, '') %>?text=<%= encodeURIComponent('Hola, quiero informaciÃ³n del servicio de transporte.') %>">
                    Escribir
                </a>
                <button type="button" class="btn btn-ghost btn-sm" id="copyPhoneBtn">Copiar</button>
            </div>
        </div>
    </footer>

</main>

<script src="/js/theme.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /* ===== Admin login oculto: mantener presionado el LOGO ===== */
    (function () {
        const hotspot = document.getElementById("adminHotspot");
        if (!hotspot) return;

        const HOLD_MS = 1500;

        let holdTimer = null;
        let usingTouch = false;

        function go() {
            holdTimer = null;
            window.location.href = "/admin/login";
        }

        function start(e) {
            const isTouch = (e.type && e.type.startsWith("touch")) || e.pointerType === "touch";
            if (isTouch && e.cancelable) e.preventDefault();

            if (holdTimer) return;

            if (e.type && e.type.startsWith("touch")) usingTouch = true;
            holdTimer = setTimeout(go, HOLD_MS);
        }

        function cancel() {
            if (!holdTimer) return;
            clearTimeout(holdTimer);
            holdTimer = null;
        }

        hotspot.addEventListener("touchstart", start, { passive: false });
        hotspot.addEventListener("touchend", cancel);
        hotspot.addEventListener("touchcancel", cancel);
        hotspot.addEventListener("touchmove", cancel);

        hotspot.addEventListener("pointerdown", (e) => {
            if (usingTouch) return;
            start(e);
        }, { passive: false });

        hotspot.addEventListener("pointerup", cancel);
        hotspot.addEventListener("pointercancel", cancel);
        hotspot.addEventListener("pointerleave", cancel);

        hotspot.addEventListener("contextmenu", (e) => e.preventDefault());

        hotspot.addEventListener("touchend", () => {
            setTimeout(() => { usingTouch = false; }, 0);
        });
    })();

    /* ===== PrÃ³ximas salidas (muestra la prÃ³xima REAL aunque estÃ© llena + mensaje si estÃ¡ lleno) ===== */
    (function () {
        const card = document.getElementById("nextCard");

        const elV2L = document.getElementById("nextV2L");
        const elV2LTime = document.getElementById("nextV2LTime");
        const elV2LWhen = document.getElementById("nextV2LWhen");
        const elV2LLink = document.getElementById("nextV2LLink");

        const elL2V = document.getElementById("nextL2V");
        const elL2VTime = document.getElementById("nextL2VTime");
        const elL2VWhen = document.getElementById("nextL2VWhen");
        const elL2VLink = document.getElementById("nextL2VLink");

        if (!card || !elV2L || !elL2V) return;

        function todayISO_MTY() {
            return new Date().toLocaleDateString("en-CA", {timeZone: "America/Monterrey"});
        }

        function addDaysISO(baseISO, days) {
            const [y, m, d] = String(baseISO).split("-").map(Number);
            const dt = new Date(Date.UTC(y, (m || 1) - 1, d || 1));
            dt.setUTCDate(dt.getUTCDate() + Number(days || 0));

            const yy = dt.getUTCFullYear();
            const mm = String(dt.getUTCMonth() + 1).padStart(2, "0");
            const dd = String(dt.getUTCDate()).padStart(2, "0");
            return `${yy}-${mm}-${dd}`;
        }

        function toHHMM(t) {
            const s = String(t || "").trim();
            if (/^\d{2}:\d{2}$/.test(s)) return s;
            if (/^\d{2}:\d{2}:\d{2}$/.test(s)) return s.slice(0, 5);
            const parts = s.split(":");
            if (parts.length >= 2) {
                return `${String(parts[0]).padStart(2, "0")}:${String(parts[1]).slice(0, 2).padStart(2, "0")}`;
            }
            return s;
        }

        async function fetchAvailability(dateISO, dir, seats) {
            // seats=0 => informativo: incluye horarios aunque estÃ©n llenos
            const url =
                `/availability?date=${encodeURIComponent(dateISO)}` +
                `&direction=${encodeURIComponent(dir)}` +
                `&seats=${encodeURIComponent(seats)}`;

            const res = await fetch(url, {headers: {Accept: "application/json"}});
            const data = await res.json();
            return Array.isArray(data?.results) ? data.results : [];
        }

        async function findNext(dir, seats) {
            const base = todayISO_MTY();

            for (let offset = 0; offset <= 7; offset++) {
                const dateISO = addDaysISO(base, offset);

                let results = [];
                try {
                    results = await fetchAvailability(dateISO, dir, seats);
                } catch {
                    results = [];
                }

                const slots = results
                    .map(r => ({
                        hhmm: toHHMM(r.time ?? r.depart_time ?? ""),
                        available: Number(r.available ?? 0),
                    }))
                    .filter(x => x.hhmm)
                    .sort((a, b) => a.hhmm.localeCompare(b.hhmm));

                if (slots.length) {
                    const when = offset === 0 ? "hoy" : offset === 1 ? "maÃ±ana" : dateISO;
                    const first = slots[0];
                    return {dateISO, when, hhmm: first.hhmm, available: first.available};
                }
            }

            return null;
        }

        Promise.all([
            // next REAL (even if full)
            findNext("VIC_TO_LLE", 0),
            findNext("LLE_TO_VIC", 0),
            // next reservable (needs >=1 seat)
            findNext("VIC_TO_LLE", 1),
            findNext("LLE_TO_VIC", 1),
        ]).then(([nextV2LReal, nextL2VReal, nextV2LOk, nextL2VOk]) => {
            let any = false;

            if (nextV2LReal) {
                any = true;
                const full = Number(nextV2LReal.available || 0) <= 0;

                elV2L.style.display = "";
                elV2LTime.textContent = nextV2LReal.hhmm;

                if (full) {
                    elV2LWhen.textContent =
                        `Salida ${nextV2LReal.when} Â· Lleno` +
                        (nextV2LOk ? ` Â· Siguiente con cupo: ${nextV2LOk.hhmm} (${nextV2LOk.when})` : "");

                    // botÃ³n se queda en "Reservar", pero si estÃ¡ lleno lo mando al siguiente con cupo (si existe)
                    elV2LLink.href = nextV2LOk
                        ? `/reserve?dir=VIC_TO_LLE&time=${encodeURIComponent(nextV2LOk.hhmm)}&date=${encodeURIComponent(nextV2LOk.dateISO)}`
                        : `/reserve?dir=VIC_TO_LLE&date=${encodeURIComponent(nextV2LReal.dateISO)}`;
                } else {
                    elV2LWhen.textContent = `Salida ${nextV2LReal.when}`;
                    elV2LLink.href = `/reserve?dir=VIC_TO_LLE&time=${encodeURIComponent(nextV2LReal.hhmm)}&date=${encodeURIComponent(nextV2LReal.dateISO)}`;
                }
            }

            if (nextL2VReal) {
                any = true;
                const full = Number(nextL2VReal.available || 0) <= 0;

                elL2V.style.display = "";
                elL2VTime.textContent = nextL2VReal.hhmm;

                if (full) {
                    elL2VWhen.textContent =
                        `Salida ${nextL2VReal.when} Â· Lleno` +
                        (nextL2VOk ? ` Â· Siguiente con cupo: ${nextL2VOk.hhmm} (${nextL2VOk.when})` : "");

                    elL2VLink.href = nextL2VOk
                        ? `/reserve?dir=LLE_TO_VIC&time=${encodeURIComponent(nextL2VOk.hhmm)}&date=${encodeURIComponent(nextL2VOk.dateISO)}`
                        : `/reserve?dir=LLE_TO_VIC&date=${encodeURIComponent(nextL2VReal.dateISO)}`;
                } else {
                    elL2VWhen.textContent = `Salida ${nextL2VReal.when}`;
                    elL2VLink.href = `/reserve?dir=LLE_TO_VIC&time=${encodeURIComponent(nextL2VReal.hhmm)}&date=${encodeURIComponent(nextL2VReal.dateISO)}`;
                }
            }

            if (any) card.style.display = "";
        });
    })();

    /* ===== Copiar telÃ©fono ===== */
    (function () {
        const btn = document.getElementById("copyPhoneBtn");
        const phone = "8344756376";
        if (!btn) return;

        btn.addEventListener("click", async () => {
            try {
                await navigator.clipboard.writeText(phone);
                const old = btn.textContent;
                btn.textContent = "Copiado";
                setTimeout(() => btn.textContent = old, 1400);
            } catch {
                alert("No pude copiar. NÃºmero: " + phone);
            }
        });
    })();
</script>

</body>
</html>
