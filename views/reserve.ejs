<!doctype html>
<html lang="es" data-theme="light">
<head>
    <link href="/css/theme.css" rel="stylesheet">
    <%- include('partials/head') %>
    <title>Reservar</title>

    <style>
        /* =========================
           Reserva - mejoras UI
           ========================= */

        .form-label {
            font-weight: 600;
        }

        .help {
            color: var(--muted);
            font-size: .9rem;
        }

        /* Stepper estilo "lista desplegable" (form-select) pero con + / - */
        .stepper {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;

            height: calc(2.375rem + 2px);
            padding: .375rem .75rem;
            border: 1px solid var(--border);
            border-radius: .375rem;
            background: var(--card);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, .06);
            gap: 10px;
        }

        .stepper:focus-within {
            border-color: color-mix(in srgb, var(--wine) 55%, var(--border));
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, .06),
            0 0 0 .25rem color-mix(in srgb, var(--wine) 22%, transparent);
        }

        .stepper .btn-step {
            width: 34px;
            height: 30px;
            border-radius: .375rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            font-weight: 800;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .stepper .btn-step:hover {
            border-color: color-mix(in srgb, var(--wine) 45%, var(--border));
            background: color-mix(in srgb, var(--card) 75%, transparent);
        }

        .stepper .btn-step:disabled {
            opacity: .45;
            cursor: not-allowed;
        }

        .stepper .count {
            flex: 1;
            text-align: center;
            font-weight: 650;
            letter-spacing: -.01em;
            color: var(--text);
            user-select: none;
        }

        .slots-wrap {
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 14px;
            background: color-mix(in srgb, var(--card) 90%, transparent);
        }

        .slots-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .slots-title {
            font-weight: 650;
            letter-spacing: -.01em;
            margin: 0;
        }

        .slots-sub {
            color: var(--muted);
            font-size: .9rem;
        }

        .slot-section {
            margin-top: 12px;
        }

        .slot-section:first-child {
            margin-top: 0;
        }

        .section-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            font-weight: 650;
            font-size: .9rem;
            margin-bottom: 8px;
        }

        .slots {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .slot-pill {
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 92%, transparent);
            border-radius: 999px;
            padding: 10px 12px;
            cursor: pointer;
            transition: transform .06s ease, border-color .12s ease, background .12s ease;
            color: var(--text);
            user-select: none;

            display: inline-flex;
            align-items: center;
            gap: 10px;
            line-height: 1;
        }

        .slot-pill:hover {
            transform: translateY(-1px);
            border-color: color-mix(in srgb, var(--wine) 45%, var(--border));
            background: color-mix(in srgb, var(--card) 78%, transparent);
        }

        .slot-pill[aria-selected="true"] {
            border-color: color-mix(in srgb, var(--wine) 75%, var(--border));
            background: color-mix(in srgb, var(--chip-bg) 70%, var(--card));
            box-shadow: 0 10px 26px rgba(2, 6, 23, .10);
        }

        .slot-pill .time {
            font-weight: 650;
            white-space: nowrap;
        }

        .slot-pill .mini {
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            padding: .18rem .5rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 86%, transparent);
            color: var(--muted);
            font-size: .82rem;
            white-space: nowrap;
        }

        .slot-pill.is-warning .mini {
            background: rgba(241, 220, 33, .14);
            color: color-mix(in srgb, #f1dc21 60%, var(--text));
        }

        .slot-pill.is-danger {
            opacity: .55;
            pointer-events: none;
        }

        .card-soft .row.g-3 > [class*="col-"] {
            padding-top: 2px;
        }

        #onlineWrap .alert {
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .45rem .75rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--chip-bg);
            color: var(--chip-text);
            font-weight: 650;
            font-size: .95rem;
            white-space: nowrap;
        }

        .transfer-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: .5rem;
        }

        .tbtn {
            display: inline-flex;
            align-items: center;
            gap: .55rem;

            padding: .55rem .8rem;
            border-radius: 999px;
            border: 1px solid var(--border);

            background: color-mix(in srgb, var(--card) 92%, transparent);
            color: var(--text);

            font-weight: 650;
            letter-spacing: -.01em;
            line-height: 1;

            transition: transform .06s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
            user-select: none;
        }

        .tbtn:hover {
            transform: translateY(-1px);
            border-color: color-mix(in srgb, var(--wine) 45%, var(--border));
            background: color-mix(in srgb, var(--card) 78%, transparent);
            box-shadow: 0 10px 26px rgba(2, 6, 23, .10);
        }

        .tbtn:active {
            transform: translateY(0);
        }

        .tbtn:focus-visible {
            outline: none;
            border-color: color-mix(in srgb, var(--wine) 55%, var(--border));
            box-shadow: 0 0 0 .25rem color-mix(in srgb, var(--wine) 22%, transparent);
        }

        .tbtn-ic {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 86%, transparent);

            display: inline-flex;
            align-items: center;
            justify-content: center;

            font-size: .95rem;
        }

        .tbtn-txt {
            font-size: .92rem;
        }

        .form-control.is-invalid,
        .form-select.is-invalid {
            border-color: color-mix(in srgb, var(--wine) 60%, #dc3545);
            box-shadow: 0 0 0 .25rem color-mix(in srgb, var(--wine) 18%, transparent);
        }

        .invalid-feedback {
            display: none;
            margin-top: .35rem;
            font-size: .9rem;
            color: color-mix(in srgb, var(--wine) 65%, #dc3545);
        }

        .is-invalid + .invalid-feedback {
            display: block;
        }

        /* Header de "Nombres de pasajeros" */
        .names-head {
            display: flex;
            align-items: center;
            gap: 1px;
            flex-wrap: wrap;
        }

        /* Switch compacto (sin el ‚Äúsalto‚Äù/margen de Bootstrap) */
        .names-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .names-toggle .form-check-input {
            float: none !important;
        }

        .names-toggle .form-check-label {
            margin: 0;
        }

        /* En m√≥vil se apila y queda m√°s natural */
        @media (max-width: 576px) {
            .names-head {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
        }

    </style>

    <!-- ‚úÖ Inyecto pricing sin romper el JS del editor -->
    <script id="pricingJson" type="application/json"><%- JSON.stringify(
                (typeof pricing !== "undefined" && pricing) ? pricing : {
                    passenger_price_mxn: 120,
                    package_price_mxn: 120
                }
        ) %></script>
</head>

<body>
<nav class="navbar navbar-dark app-navbar">
    <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/">
            <span class="brand-dot"></span>
            <span class="fw-bold">TransportApp</span>
        </a>

        <button id="themeToggle" class="theme-btn" type="button" aria-label="Cambiar tema">
            <span id="themeIcon">üåô</span> <span class="d-none d-sm-inline">Tema</span>
        </button>
    </div>
</nav>

<main class="container py-4">

    <div class="hero mb-3">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
            <div>
                <h1 class="h3 headline mb-1">Reservar</h1>
                <div class="subtle">Elige ruta, fecha y cantidad. Te mostramos solo horarios con cupo.</div>
            </div>
            <a class="btn btn-wine" href="/">Volver</a>
        </div>
    </div>

    <div class="card-soft p-4">
        <% if (error) { %>
            <div class="alert alert-danger mb-3"><%= error %></div>
        <% } %>

        <form id="reserveForm" method="POST" action="/reserve" class="row g-3" novalidate>

            <!-- 1) Origen -->
            <div class="col-md-6">
                <label class="form-label">¬øDe d√≥nde sales?</label>
                <select id="from_city" class="form-select" required>
                    <option value="VIC" selected>Ciudad Victoria</option>
                    <option value="LLE">Llera</option>
                </select>
            </div>

            <!-- 2) Destino -->
            <div class="col-md-6">
                <label class="form-label">¬øHacia d√≥nde vas?</label>
                <select id="to_city" class="form-select" required>
                    <option value="LLE" selected>Llera</option>
                    <option value="VIC">Ciudad Victoria</option>
                </select>
            </div>

            <input type="hidden" id="direction" name="direction" value="VIC_TO_LLE">

            <!-- 3) Fecha -->
            <div class="col-md-4">
                <label class="form-label">¬øCu√°ndo viajas?</label>
                <input id="trip_date" name="trip_date" type="date" class="form-control" required/>
                <div class="form-text subtle">Por defecto se coloca el d√≠a de hoy.</div>
            </div>

            <!-- 4) Tipo -->
            <div class="col-md-4">
                <label class="form-label">¬øQu√© quieres reservar?</label>
                <select id="type" name="type" class="form-select" required>
                    <option value="PASSENGER" selected>Pasajero</option>
                    <option value="PACKAGE">Paqueter√≠a</option>
                </select>
            </div>

            <!-- 5) Cu√°ntos viajan -->
            <div class="col-md-4" id="seatsWrap">
                <label class="form-label">¬øCu√°ntos viajan?</label>

                <div class="stepper">
                    <button id="minusBtn" type="button" class="btn-step" aria-label="Disminuir">‚àí</button>
                    <div class="count"><span id="seatsText">1</span></div>
                    <button id="plusBtn" type="button" class="btn-step" aria-label="Aumentar">+</button>

                    <!-- ‚úÖ SOLO 1‚Äì6 -->
                    <select id="seats" name="seats" class="d-none">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>

                <div class="form-text subtle">M√°ximo 6 pasajeros por salida.</div>
            </div>

            <!-- ‚úÖ CONTACTO (SIEMPRE) -->
            <div class="col-md-6" id="contactNameWrap">
                <label class="form-label">Nombre de contacto</label>
                <input id="customer_name" name="customer_name" class="form-control" required
                       placeholder="Ej: Juan Mart√≠nez"/>
                <div class="form-text subtle">
                    Usaremos este nombre para tu reserva y para contactarte.
                </div>
            </div>

            <!-- Tel√©fono -->
            <div class="col-md-6">
                <label class="form-label">Tel√©fono</label>
                <input id="phone" name="phone" class="form-control" required
                       inputmode="numeric" pattern="[0-9]{10}" placeholder="Ej: 8344756376"/>
                <div class="invalid-feedback">Ingresa un tel√©fono v√°lido (10 d√≠gitos).</div>
            </div>

            <!-- ‚úÖ PASAJEROS (OPCIONAL) -->
            <div class="col-12" id="passengerNamesWrap">
                <div class="form-check form-switch m-0 names-toggle" id="namesToggleWrap">
                    <input class="form-check-input" type="checkbox" id="namesToggle">
                    <label class="form-check-label subtle" for="namesToggle">Capturar nombres</label>
                </div>

                <div class="form-text subtle mt-1">
                    Puedes omitir los nombres y solo usar el contacto.
                </div>

                <div id="passengerNamesBox" class="mt-2 d-none">
                    <div id="passengerNames" class="row g-2"></div>
                    <div class="form-text">
                        Si activas esta opci√≥n, capturamos un nombre por asiento.
                    </div>
                </div>
            </div>

            <!-- M√âTODO DE PAGO -->
            <div class="col-md-6">
                <label class="form-label">M√©todo de pago</label>
                <select id="payment_method" name="payment_method" class="form-select" required>
                    <option value="TAQUILLA" selected>Taquilla</option>
                    <option value="TRANSFERENCIA">Transferencia</option>
                    <option value="ONLINE">Pago en l√≠nea</option>
                </select>
                <div class="form-text subtle">Elige c√≥mo deseas pagar tu reserva.</div>
            </div>

            <!-- TOTAL A PAGAR -->
            <div class="col-12">
                <div class="slots-wrap">
                    <div class="slots-head">
                        <p class="slots-title mb-0">Total a pagar</p>
                        <div class="slots-sub" id="priceHint">Cargando precio‚Ä¶</div>
                    </div>

                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <span class="pill">üí∞ <span id="priceTotal">$0</span></span>
                        <span class="help" id="priceBreakdown"></span>
                    </div>
                </div>
            </div>

            <!-- TRANSFERENCIA -->
            <div class="col-12 d-none" id="transferWrap">
                <div class="slots-wrap">
                    <div class="slots-head">
                        <p class="slots-title mb-0">Datos para transferencia</p>
                        <div class="slots-sub">Realiza la transferencia y env√≠a el comprobante por WhatsApp.</div>
                    </div>

                    <ul class="kv mb-3">
                        <li><span class="k">Banco: </span><span class="v" id="bankName">BBVA</span></li>
                        <li><span class="k">Beneficiario: </span><span class="v" id="bankOwner">Gary Trevi√±o</span></li>
                        <li>
                            <span class="k">N√∫mero de tarjeta: </span>
                            <span class="v mono" id="bankClabe">4152 3142 8477 3416</span>
                        </li>
                    </ul>

                    <div class="transfer-actions">
                        <button type="button" class="tbtn" id="copyClabeBtn" aria-label="Copiar n√∫mero de tarjeta">
                            <span class="tbtn-ic">üìã</span>
                            <span class="tbtn-txt">Copiar tarjeta</span>
                        </button>

                        <button type="button" class="tbtn" id="copyTransferMsgBtn"
                                aria-label="Copiar mensaje de transferencia">
                            <span class="tbtn-ic">üí¨</span>
                            <span class="tbtn-txt">Copiar mensaje</span>
                        </button>
                    </div>

                    <div class="note mb-3">
                        <strong>Concepto sugerido:</strong> ‚ÄúServicio de transporte‚Äù
                        <span class="subtle">(tu folio se genera al finalizar)</span>.
                        <br>
                        Despu√©s, env√≠anos el comprobante por WhatsApp para confirmar.
                    </div>

                    <label class="form-label">Referencia / folio de transferencia (opcional)</label>
                    <input id="transfer_ref" name="transfer_ref" class="form-control"
                           placeholder="Ej: 123456 / SPEI / concepto"/>
                    <div class="form-text subtle">
                        Si ya hiciste la transferencia, pega aqu√≠ la referencia. Si no, puedes dejarlo vac√≠o.
                    </div>
                </div>
            </div>

            <!-- ONLINE: aviso -->
            <div class="col-12 d-none" id="onlineWrap">
                <div class="alert alert-info mb-0">
                    <strong>Pago en l√≠nea:</strong> al confirmar la reserva te llevaremos al pago del pasaje.
                </div>
            </div>

            <!-- PAQUETER√çA -->
            <div class="col-12" id="packageWrap">
                <label class="form-label">Detalle paqueter√≠a (obligatorio)</label>
                <input id="package_details" name="package_details" class="form-control"
                       placeholder="Ej: sobre, refacciones, etc."/>
            </div>

            <!-- Horarios -->
            <div class="col-12">
                <label class="form-label">Hora (seg√∫n cupo)</label>
                <input type="hidden" id="depart_time" name="depart_time" value="">

                <div class="slots-wrap">
                    <div class="slots-head">
                        <p class="slots-title mb-0">Horarios disponibles</p>
                        <div class="slots-sub" id="slotsHint">Selecciona fecha y ruta.</div>
                    </div>

                    <div id="slotsLoading" class="help">‚Äî</div>

                    <div id="sections" class="d-none">
                        <div class="slot-section" id="morningSection">
                            <div class="section-label">üå§Ô∏è Ma√±ana</div>
                            <div id="morningSlots" class="slots"></div>
                        </div>

                        <div class="slot-section" id="afternoonSection">
                            <div class="section-label">üåá Tarde</div>
                            <div id="afternoonSlots" class="slots"></div>
                        </div>
                    </div>
                </div>

                <div class="form-text subtle mt-2">Te mostramos horarios con cupo para tu selecci√≥n.</div>
                <div class="form-text subtle mt-2">Para cancelaciones favor de enviar tu ticket, con m√≠nimo 1 hora de
                    anticipaci√≥n antes de tu viaje para realizar tu devoluci√≥n sino no hay reembolso.
                </div>
            </div>

            <div class="col-12 d-flex gap-2 flex-wrap mt-2">
                <button class="btn btn-wine px-4">Confirmar reserva</button>
                <a class="btn btn-outline-secondary px-4" href="/">Cancelar</a>
            </div>

        </form>
    </div>

</main>

<%- include('partials/toast') %>
<%- include('partials/footer') %>

<script>
    const tripDate = document.getElementById("trip_date");

    const fromCity = document.getElementById("from_city");
    const toCity = document.getElementById("to_city");
    const directionInput = document.getElementById("direction");

    const typeSel = document.getElementById("type");

    const seatsWrap = document.getElementById("seatsWrap");
    const seatsSel = document.getElementById("seats");
    const seatsText = document.getElementById("seatsText");
    const plusBtn = document.getElementById("plusBtn");
    const minusBtn = document.getElementById("minusBtn");

    const customerName = document.getElementById("customer_name");

    const passengerNamesWrap = document.getElementById("passengerNamesWrap");
    const passengerNamesBox = document.getElementById("passengerNamesBox");
    const passengerNames = document.getElementById("passengerNames");
    const namesToggleWrap = document.getElementById("namesToggleWrap");
    const namesToggle = document.getElementById("namesToggle");

    const paymentMethod = document.getElementById("payment_method");
    const transferWrap = document.getElementById("transferWrap");
    const onlineWrap = document.getElementById("onlineWrap");

    const packageWrap = document.getElementById("packageWrap");
    const packageDetails = document.getElementById("package_details");

    const departTimeHidden = document.getElementById("depart_time");

    const slotsHint = document.getElementById("slotsHint");
    const slotsLoading = document.getElementById("slotsLoading");
    const sections = document.getElementById("sections");
    const morningSection = document.getElementById("morningSection");
    const afternoonSection = document.getElementById("afternoonSection");
    const morningSlots = document.getElementById("morningSlots");
    const afternoonSlots = document.getElementById("afternoonSlots");

    const priceTotal = document.getElementById("priceTotal");
    const priceBreakdown = document.getElementById("priceBreakdown");
    const priceHint = document.getElementById("priceHint");

    const copyClabeBtn = document.getElementById("copyClabeBtn");
    const copyTransferMsgBtn = document.getElementById("copyTransferMsgBtn");
    const bankClabeEl = document.getElementById("bankClabe");

    const formEl = document.getElementById("reserveForm");

    // ‚úÖ I use this to preselect direction/time coming from the index chips (/reserve?dir=...&time=...)
    let PREFERRED_TIME = null;

    // ‚úÖ pricing inicial desde server (sin romper el JS del editor)
    function parsePricingFromServer() {
        try {
            const el = document.getElementById("pricingJson");
            const raw = el ? el.textContent : "{}";
            const obj = JSON.parse(raw || "{}");
            return {
                passenger_price_mxn: Number(obj?.passenger_price_mxn ?? 120),
                package_price_mxn: Number(obj?.package_price_mxn ?? 120),
            };
        } catch {
            return {passenger_price_mxn: 120, package_price_mxn: 120};
        }
    }

    let PRICING = parsePricingFromServer();
    let PRICING_OK = true;

    function todayISO() {
        return new Date().toLocaleDateString("en-CA", {timeZone: "America/Monterrey"});
    }

    async function loadPricing() {
        // I refresh pricing from /pricing, but I already have a server-side default.
        try {
            const res = await fetch("/pricing", {headers: {"Accept": "application/json"}});
            const data = await res.json();

            if (data?.ok) {
                PRICING = {
                    passenger_price_mxn: Number(data.passenger_price_mxn ?? PRICING.passenger_price_mxn ?? 120),
                    package_price_mxn: Number(data.package_price_mxn ?? PRICING.package_price_mxn ?? 120),
                };
                PRICING_OK = true;
            } else {
                PRICING_OK = false;
            }
        } catch {
            PRICING_OK = false;
        } finally {
            updatePriceUI();
        }
    }

    function toHHMM(t) {
        const s = String(t || "").trim();
        const parts = s.split(":");
        if (parts.length >= 2) return `${parts[0].padStart(2, "0")}:${parts[1].padStart(2, "0")}`;
        return s;
    }

    function hourFromTime(t) {
        const hhmm = toHHMM(t);
        const hh = Number((hhmm.split(":")[0] || "0"));
        return isNaN(hh) ? 0 : hh;
    }

    function setSeats(n) {
        const value = Math.max(1, Math.min(6, Number(n || 1)));
        seatsSel.value = String(value);
        seatsText.textContent = String(value);

        minusBtn.disabled = value <= 1;
        plusBtn.disabled = value >= 6;

        updatePriceUI();
    }

    function syncDirection() {
        const f = fromCity.value;
        const t = toCity.value;

        if (f === t) toCity.value = (f === "VIC") ? "LLE" : "VIC";

        const from = fromCity.value;
        const to = toCity.value;

        directionInput.value = (from === "VIC" && to === "LLE") ? "VIC_TO_LLE" : "LLE_TO_VIC";
    }

    function applyPrefillFromQuery() {
        try {
            const qs = new URLSearchParams(window.location.search);

            const dir = (qs.get("dir") || qs.get("direction") || "").trim().toUpperCase();
            const timeRaw = (qs.get("time") || qs.get("depart_time") || "").trim();
            const date = (qs.get("date") || qs.get("trip_date") || "").trim();

            // Normalizo HH:MM (si viene 6:30 => 06:30)
            const time = timeRaw ? toHHMM(timeRaw) : "";

            // Aplico direcci√≥n a selects (para que syncDirection() ya deje bien el hidden)
            if (dir === "VIC_TO_LLE") {
                fromCity.value = "VIC";
                toCity.value = "LLE";
            } else if (dir === "LLE_TO_VIC") {
                fromCity.value = "LLE";
                toCity.value = "VIC";
            }

            // Fecha (YYYY-MM-DD)
            if (date) {
                tripDate.value = date;
            }

            // Hora preferida para seleccionar al renderizar slots
            if (time) {
                PREFERRED_TIME = time; // ya viene en HH:MM
            }

            // ‚úÖ Limpio URL (solo est√©tica) sin recargar
            if (dir || time || date) {
                const clean = new URL(window.location.href);

                if (dir) clean.searchParams.set("dir", dir);
                if (time) clean.searchParams.set("time", time);
                else clean.searchParams.delete("time");

                if (date) clean.searchParams.set("date", date);
                else clean.searchParams.delete("date");

                clean.searchParams.delete("direction");
                clean.searchParams.delete("depart_time");
                clean.searchParams.delete("trip_date");

                window.history.replaceState({}, "", clean.toString());
            }
        } catch {
            // no-op
        }
    }

    function namesEnabled() {
        return !!namesToggle?.checked;
    }

    function updateUIByType() {
        const isPassenger = typeSel.value === "PASSENGER";

        seatsWrap.style.display = isPassenger ? "" : "none";

        // I show the "capture names" switch only for passengers.
        namesToggleWrap.style.display = isPassenger ? "" : "none";

        // I show/hide package detail.
        packageWrap.style.display = isPassenger ? "none" : "";

        // I enforce package details only for packages.
        if (!isPassenger) {
            packageDetails.setAttribute("required", "required");

            // I disable passenger names when switching to package.
            if (namesToggle) namesToggle.checked = false;
            passengerNames.innerHTML = "";
            passengerNamesBox.classList.add("d-none");
        } else {
            packageDetails.value = "";
            packageDetails.removeAttribute("required");
        }

        updatePriceUI();
        renderPassengerInputs();
    }

    function updateUIByPayment() {
        const m = paymentMethod.value;
        const isTransfer = m === "TRANSFERENCIA";
        const isOnline = m === "ONLINE";

        transferWrap.classList.toggle("d-none", !isTransfer);
        onlineWrap.classList.toggle("d-none", !isOnline);
    }

    function renderPassengerInputs() {
        const isPassenger = typeSel.value === "PASSENGER";
        const seats = Number(seatsSel.value || 1);

        passengerNames.innerHTML = "";

        // I only render passenger name inputs if the user explicitly wants them.
        if (!isPassenger || !namesEnabled()) {
            passengerNamesBox.classList.add("d-none");
            return;
        }

        passengerNamesBox.classList.remove("d-none");

        for (let i = 1; i <= seats; i++) {
            const col = document.createElement("div");
            col.className = "col-md-4";
            col.innerHTML = `
                <input class="form-control" name="passenger_names[]" required
                       placeholder="Pasajero ${i} (Nombre completo)" />
            `;
            passengerNames.appendChild(col);
        }
    }

    function clearSlotsUI(msg) {
        departTimeHidden.value = "";
        slotsLoading.textContent = msg || "Selecciona fecha y ruta para ver horarios.";
        sections.classList.add("d-none");
        morningSlots.innerHTML = "";
        afternoonSlots.innerHTML = "";
        morningSection.classList.remove("d-none");
        afternoonSection.classList.remove("d-none");
    }

    function setSelectedTime(hhmm) {
        const value = toHHMM(hhmm);
        departTimeHidden.value = value;

        document.querySelectorAll(".slot-pill").forEach(el => {
            el.setAttribute("aria-selected", (el.dataset.time === value) ? "true" : "false");
        });
    }

    function createPill({time, available, seatsNeeded}) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "slot-pill";
        const hhmm = toHHMM(time);
        btn.dataset.time = hhmm;
        btn.setAttribute("aria-selected", "false");

        if (seatsNeeded > 0) {
            if (available <= 2) btn.classList.add("is-warning");
            if (available <= 0) btn.classList.add("is-danger");
        }

        const extra = (seatsNeeded > 0)
            ? `<span class="mini">para ${seatsNeeded}</span>`
            : `<span class="mini">Paqueter√≠a</span>`;

        btn.innerHTML = `
            <span class="time">üïí ${hhmm}</span>
            <span class="mini">üë• ${available} libres</span>
            ${extra}
        `;

        btn.addEventListener("click", () => setSelectedTime(hhmm));
        return btn;
    }

    function renderSlotsGrouped(results, seatsNeeded) {
        const requiresCapacity = seatsNeeded > 0;

        const items = (results || [])
            .map(x => ({time: toHHMM(x.time), available: Number(x.available || 0)}))
            .filter(x => requiresCapacity ? (x.available >= seatsNeeded) : true)
            .sort((a, b) => a.time.localeCompare(b.time));

        if (!items.length) {
            clearSlotsUI(requiresCapacity
                ? "No hay horarios con cupo suficiente para tu selecci√≥n."
                : "No hay horarios para esta fecha/ruta.");
            return;
        }

        const morning = items.filter(x => hourFromTime(x.time) < 12);
        const afternoon = items.filter(x => hourFromTime(x.time) >= 12);

        morningSlots.innerHTML = "";
        afternoonSlots.innerHTML = "";

        if (!morning.length) morningSection.classList.add("d-none"); else morningSection.classList.remove("d-none");
        if (!afternoon.length) afternoonSection.classList.add("d-none"); else afternoonSection.classList.remove("d-none");

        morning.forEach(x => morningSlots.appendChild(createPill({...x, seatsNeeded})));
        afternoon.forEach(x => afternoonSlots.appendChild(createPill({...x, seatsNeeded})));

        sections.classList.remove("d-none");
        slotsLoading.textContent = "Selecciona un horario:";

        // ‚úÖ If I have a preferred time from the index, I try to select it.
        const preferred = PREFERRED_TIME ? toHHMM(PREFERRED_TIME) : null;
        const found = preferred ? items.find(x => x.time === preferred) : null;

        const initial = (found ? found.time : (morning[0] || afternoon[0]).time);
        setSelectedTime(initial);

        // ‚úÖ I clear preferred time after it successfully matches, so later reloads behave normal.
        if (found) PREFERRED_TIME = null;
    }

    async function loadAvailability() {
        const date = tripDate.value;
        const dir = directionInput.value;

        if (!date || !dir) {
            clearSlotsUI("Selecciona fecha y ruta para ver horarios.");
            return;
        }

        const seatsNeeded = (typeSel.value === "PASSENGER")
            ? Number(seatsSel.value || 1)
            : 0;

        slotsLoading.textContent = "Cargando horarios...";
        sections.classList.add("d-none");
        departTimeHidden.value = "";

        try {
            const url = `/availability?date=${encodeURIComponent(date)}&direction=${encodeURIComponent(dir)}&seats=${encodeURIComponent(seatsNeeded)}`;
            const res = await fetch(url);
            const data = await res.json();

            renderSlotsGrouped(data.results || [], seatsNeeded);
        } catch (e) {
            clearSlotsUI("Error al cargar horarios. Intenta de nuevo.");
        }
    }

    function formatMXN(n) {
        const v = Number(n || 0);
        return `$${v.toFixed(2)} MXN`;
    }

    function buildTransferMessage() {
        const bank = document.getElementById("bankName")?.textContent?.trim() || "";
        const owner = document.getElementById("bankOwner")?.textContent?.trim() || "";
        const card = document.getElementById("bankClabe")?.textContent?.trim() || "";

        const dir = (directionInput.value === "VIC_TO_LLE") ? "Victoria - Llera" : "Llera - Victoria";
        const date = tripDate.value || "-";
        const time = departTimeHidden.value || "(sin horario a√∫n)";
        const type = (typeSel.value === "PASSENGER") ? "Pasaje" : "Paqueter√≠a";
        const seats = Number(seatsSel.value || 1);

        const totalText = priceTotal?.textContent || "";
        const contact = (customerName?.value || "").trim();

        return [
            "Datos para transferencia (TransportApp)",
            "--------------------------------------",
            `Banco: ${bank}`,
            `Beneficiario: ${owner}`,
            `N√∫mero de tarjeta: ${card}`,
            "",
            "Datos de mi reserva",
            "-------------------",
            `Contacto: ${contact || "-"}`,
            `Ruta: ${dir}`,
            `Fecha: ${date}`,
            `Hora: ${time}`,
            `Tipo: ${type}${typeSel.value === "PASSENGER" ? ` (${seats} pasajero(s))` : ""}`,
            `Total: ${totalText}`,
            "",
            "Nota: El folio se genera al finalizar la reserva."
        ].join("\n");
    }

    copyClabeBtn?.addEventListener("click", async () => {
        try {
            const rawCard = bankClabeEl?.textContent?.trim() || "";
            const cardNoSpaces = rawCard.replace(/\s+/g, "").replace(/-/g, "");
            await navigator.clipboard.writeText(cardNoSpaces);
            notify("N√∫mero de tarjeta copiado", {variant: "success"});
        } catch {
            notify("No pude copiar el n√∫mero. Selecci√≥nalo manualmente.", {variant: "danger", delay: 2500});
        }
    });

    copyTransferMsgBtn?.addEventListener("click", async () => {
        try {
            await navigator.clipboard.writeText(buildTransferMessage());
            notify("Mensaje copiado", {variant: "success"});
        } catch {
            notify("No pude copiar el mensaje. Intenta de nuevo.", {variant: "danger", delay: 2500});
        }
    });

    function updatePriceUI() {
        const isPassenger = typeSel.value === "PASSENGER";
        const seats = Number(seatsSel.value || 1);

        const unit = isPassenger
            ? Number(PRICING.passenger_price_mxn || 0)
            : Number(PRICING.package_price_mxn || 0);

        const total = isPassenger ? (unit * seats) : unit;

        priceTotal.textContent = formatMXN(total);

        if (isPassenger) {
            priceBreakdown.textContent = `${formatMXN(unit)} x ${seats} pasajero(s)`;
            priceHint.textContent = PRICING_OK ? "Pasaje (precio actual)" : "Pasaje (estimado)";
        } else {
            priceBreakdown.textContent = `${formatMXN(unit)} (costo fijo)`;
            priceHint.textContent = PRICING_OK ? "Paqueter√≠a (precio actual)" : "Paqueter√≠a (estimado)";
        }
    }

    function fieldLabel(el) {
        if (el.id) {
            const lf = formEl.querySelector(`label[for="${el.id}"]`);
            if (lf) return lf.textContent.trim();
        }
        const wrap = el.closest('[class*="col-"]');
        const l2 = wrap?.querySelector("label.form-label");
        if (l2) return l2.textContent.trim();
        return el.placeholder || el.name || "este campo";
    }

    function messageForInvalid(el) {
        const name = fieldLabel(el);
        if (el.id === "phone" && el.validity.patternMismatch) return `Revisa "${name}": deben ser 10 d√≠gitos.`;
        if (el.validity.valueMissing) return `Completa "${name}".`;
        if (el.validity.patternMismatch) return `Revisa "${name}" (formato inv√°lido).`;
        if (el.validity.typeMismatch) return `Revisa "${name}".`;
        return `Revisa "${name}".`;
    }

    function markInvalid(el) {
        el.classList.add("is-invalid");
    }

    function clearInvalid(el) {
        el.classList.remove("is-invalid");
    }

    formEl.addEventListener("input", (e) => clearInvalid(e.target), true);
    formEl.addEventListener("change", (e) => clearInvalid(e.target), true);

    formEl.addEventListener("submit", (e) => {
        const invalid = formEl.querySelector(":invalid");
        if (invalid) {
            e.preventDefault();
            [...formEl.querySelectorAll(":invalid")].forEach(markInvalid);

            notify(messageForInvalid(invalid), {variant: "warning", delay: 2600});

            invalid.focus({preventScroll: true});
            invalid.scrollIntoView({behavior: "smooth", block: "center"});
            return;
        }

        if (!departTimeHidden.value) {
            e.preventDefault();
            notify("Selecciona un horario disponible antes de confirmar.", {variant: "warning", delay: 2500});
            document.getElementById("sections")?.closest(".slots-wrap")?.scrollIntoView({
                behavior: "smooth",
                block: "center"
            });
            return;
        }
    });

    fromCity.addEventListener("change", () => {
        syncDirection();
        loadAvailability();
    });
    toCity.addEventListener("change", () => {
        syncDirection();
        loadAvailability();
    });

    tripDate.addEventListener("change", loadAvailability);

    typeSel.addEventListener("change", () => {
        updateUIByType();
        loadAvailability();
    });

    namesToggle?.addEventListener("change", () => {
        renderPassengerInputs();
    });

    plusBtn.addEventListener("click", () => {
        setSeats(Number(seatsSel.value || 1) + 1);
        renderPassengerInputs();
        loadAvailability();
    });

    minusBtn.addEventListener("click", () => {
        setSeats(Number(seatsSel.value || 1) - 1);
        renderPassengerInputs();
        loadAvailability();
    });

    paymentMethod.addEventListener("change", updateUIByPayment);

    // ‚úÖ I apply query prefill before syncing direction and loading availability
    applyPrefillFromQuery();

    syncDirection();
    updateUIByType();
    updateUIByPayment();

    if (!tripDate.value) tripDate.value = todayISO();

    setSeats(1);
    renderPassengerInputs();

    // ‚úÖ pintar precio inmediato con lo que vino del server
    updatePriceUI();

    // ‚úÖ refrescar pricing desde DB (por si cambi√≥)
    loadPricing();

    // horarios
    loadAvailability();
</script>

</body>
</html>