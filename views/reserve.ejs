<!doctype html>
<html lang="es" data-theme="light">
<head>
    <%- include('partials/head', {
    title: 'Reservar | Servicio de Transporte',
    description: 'Reserva tu viaje Victoria ‚Üî Llera. Elige ruta, fecha y horarios con cupo.',
    canonicalUrl: 'https://serviciodetransportevic.com/reserve'
    }) %>

    <style>
        /* =========================
           Reserva - mejoras UI
           ========================= */

        .form-label {
            font-weight: 600;
        }

        .help {
            color: var(--muted);
            font-size: .9rem;
        }

        /* Stepper estilo "lista desplegable" (form-select) pero con + / - */
        .stepper {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;

            height: calc(2.375rem + 2px);
            padding: .375rem .75rem;
            border: 1px solid var(--border);
            border-radius: .375rem;
            background: var(--card);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, .06);
            gap: 10px;
        }

        .stepper:focus-within {
            border-color: color-mix(in srgb, var(--wine) 55%, var(--border));
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, .06),
            0 0 0 .25rem color-mix(in srgb, var(--wine) 22%, transparent);
        }

        .stepper .btn-step {
            width: 34px;
            height: 30px;
            border-radius: .375rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            font-weight: 800;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .stepper .btn-step:hover {
            border-color: color-mix(in srgb, var(--wine) 45%, var(--border));
            background: color-mix(in srgb, var(--card) 75%, transparent);
        }

        .stepper .btn-step:disabled {
            opacity: .45;
            cursor: not-allowed;
        }

        .stepper .count {
            flex: 1;
            text-align: center;
            font-weight: 650;
            letter-spacing: -.01em;
            color: var(--text);
            user-select: none;
        }

        .slots-wrap {
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 14px;
            background: color-mix(in srgb, var(--card) 90%, transparent);
        }

        .slots-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .slots-title {
            font-weight: 650;
            letter-spacing: -.01em;
            margin: 0;
        }

        .slots-sub {
            color: var(--muted);
            font-size: .9rem;
        }

        .slot-section {
            margin-top: 12px;
        }

        .slot-section:first-child {
            margin-top: 0;
        }

        .section-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            font-weight: 650;
            font-size: .9rem;
            margin-bottom: 8px;
        }

        .slots {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .slot-pill {
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 92%, transparent);
            border-radius: 999px;
            padding: 10px 12px;
            cursor: pointer;
            transition: transform .06s ease, border-color .12s ease, background .12s ease;
            color: var(--text);
            user-select: none;

            display: inline-flex;
            align-items: center;
            gap: 10px;
            line-height: 1;
        }

        .slot-pill:hover {
            transform: translateY(-1px);
            border-color: color-mix(in srgb, var(--wine) 45%, var(--border));
            background: color-mix(in srgb, var(--card) 78%, transparent);
        }

        .slot-pill[aria-selected="true"] {
            border-color: color-mix(in srgb, var(--wine) 75%, var(--border));
            background: color-mix(in srgb, var(--chip-bg) 70%, var(--card));
            box-shadow: 0 10px 26px rgba(2, 6, 23, .10);
        }

        .slot-pill .time {
            font-weight: 650;
            white-space: nowrap;
        }

        .slot-pill .mini {
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            padding: .18rem .5rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 86%, transparent);
            color: var(--muted);
            font-size: .82rem;
            white-space: nowrap;
        }

        .slot-pill.is-warning .mini {
            background: rgba(241, 220, 33, .14);
            color: color-mix(in srgb, #f1dc21 60%, var(--text));
        }

        .slot-pill.is-danger {
            opacity: .55;
            pointer-events: none;
        }

        .card-soft .row.g-3 > [class*="col-"] {
            padding-top: 2px;
        }

        #onlineWrap .alert {
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .45rem .75rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--chip-bg);
            color: var(--chip-text);
            font-weight: 650;
            font-size: .95rem;
            white-space: nowrap;
        }

        .transfer-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: .5rem;
        }

        .transfer-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .transfer-item {
            border: 1px solid var(--border);
            border-radius: 14px;
            background: color-mix(in srgb, var(--card) 94%, transparent);
            padding: 10px 12px;
        }

        .transfer-key {
            display: block;
            font-size: .78rem;
            font-weight: 700;
            letter-spacing: .02em;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .transfer-value {
            font-size: .96rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1.2;
            word-break: break-word;
        }

        .transfer-value.mono {
            letter-spacing: .02em;
        }

        .transfer-tip {
            border: 1px dashed var(--border);
            border-radius: 14px;
            padding: 10px 12px;
            background: color-mix(in srgb, var(--card) 90%, transparent);
            margin-bottom: 12px;
        }

        .transfer-ref {
            border-top: 1px dashed var(--border);
            padding-top: 10px;
        }

        .tbtn {
            display: inline-flex;
            align-items: center;
            gap: .55rem;

            padding: .55rem .8rem;
            border-radius: 999px;
            border: 1px solid var(--border);

            background: color-mix(in srgb, var(--card) 92%, transparent);
            color: var(--text);

            font-weight: 650;
            letter-spacing: -.01em;
            line-height: 1;

            transition: transform .06s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
            user-select: none;
        }

        .tbtn:hover {
            transform: translateY(-1px);
            border-color: color-mix(in srgb, var(--wine) 45%, var(--border));
            background: color-mix(in srgb, var(--card) 78%, transparent);
            box-shadow: 0 10px 26px rgba(2, 6, 23, .10);
        }

        .tbtn:active {
            transform: translateY(0);
        }

        .tbtn:focus-visible {
            outline: none;
            border-color: color-mix(in srgb, var(--wine) 55%, var(--border));
            box-shadow: 0 0 0 .25rem color-mix(in srgb, var(--wine) 22%, transparent);
        }

        .tbtn-ic {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 86%, transparent);

            display: inline-flex;
            align-items: center;
            justify-content: center;

            font-size: .95rem;
        }

        .tbtn-ic svg {
            width: 14px;
            height: 14px;
            display: block;
        }

        .tbtn-txt {
            font-size: .92rem;
        }

        .form-control.is-invalid,
        .form-select.is-invalid {
            border-color: color-mix(in srgb, var(--wine) 60%, #dc3545);
            box-shadow: 0 0 0 .25rem color-mix(in srgb, var(--wine) 18%, transparent);
        }

        .invalid-feedback {
            display: none;
            margin-top: .35rem;
            font-size: .9rem;
            color: color-mix(in srgb, var(--wine) 65%, #dc3545);
        }

        .is-invalid + .invalid-feedback {
            display: block;
        }

        .step-inline-error {
            margin-top: .45rem;
            font-size: .9rem;
            color: color-mix(in srgb, var(--wine) 65%, #dc3545);
        }

        .step-inline-error.d-none {
            display: none;
        }

        /* Header de "Nombres de pasajeros" */
        .names-head {
            display: flex;
            align-items: center;
            gap: 1px;
            flex-wrap: wrap;
        }

        /* Switch compacto (sin el ‚Äúsalto‚Äù/margen de Bootstrap) */
        .names-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .names-toggle .form-check-input {
            float: none !important;
        }

        .names-toggle .form-check-label {
            margin: 0;
        }

        /* En m√≥vil se apila y queda m√°s natural */
        @media (max-width: 576px) {
            .names-head {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
        }

        /* =========================
           Reserva - UI refresh v2
           ========================= */
        main.container {
            position: relative;
            isolation: isolate;
        }

        main.container::before {
            content: "";
            position: absolute;
            inset: -8px -6px auto -6px;
            height: 260px;
            z-index: -1;
            pointer-events: none;
            background: radial-gradient(50% 140px at 12% 16%, rgba(106, 15, 31, .17), transparent 78%),
            radial-gradient(46% 150px at 90% 8%, rgba(15, 93, 168, .15), transparent 76%);
            filter: blur(2px);
        }

        .reserve-hero {
            border: 1px solid color-mix(in srgb, var(--border) 70%, rgba(106, 15, 31, .22));
            border-radius: 22px;
            padding: 20px;
            background: linear-gradient(125deg, color-mix(in srgb, var(--card) 92%, #ffffff 8%), color-mix(in srgb, var(--card) 98%, transparent)),
            radial-gradient(1050px 420px at 12% -18%, rgba(106, 15, 31, .17), transparent 60%);
            box-shadow: 0 20px 40px rgba(2, 6, 23, .10);
        }

        .reserve-hero .headline {
            letter-spacing: -.02em;
            font-size: clamp(1.52rem, 2.5vw, 2.06rem);
            font-weight: 760;
        }

        .reserve-tags {
            display: flex;
            gap: .52rem;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .reserve-tag {
            display: inline-flex;
            align-items: center;
            padding: .33rem .62rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 90%, transparent);
            color: color-mix(in srgb, var(--text) 90%, var(--muted));
            font-size: .81rem;
            font-weight: 700;
            letter-spacing: .01em;
        }

        .reserve-card {
            border-radius: 22px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, color-mix(in srgb, var(--card) 98%, transparent), color-mix(in srgb, var(--card) 94%, transparent));
            box-shadow: 0 18px 42px rgba(2, 6, 23, .09);
        }

        .reserve-form .form-control,
        .reserve-form .form-select,
        .reserve-form .stepper {
            border-radius: 12px;
            border: 1px solid color-mix(in srgb, var(--border) 86%, transparent);
            transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease, transform .12s ease;
        }

        .reserve-form .form-control,
        .reserve-form .form-select {
            min-height: 44px;
            padding-inline: .82rem;
            background: linear-gradient(180deg, color-mix(in srgb, var(--card) 99%, transparent), color-mix(in srgb, var(--card) 94%, transparent));
        }

        .reserve-form .form-control::placeholder {
            color: color-mix(in srgb, var(--muted) 72%, var(--text));
            opacity: .82;
        }

        .reserve-form .form-control:hover,
        .reserve-form .form-select:hover,
        .reserve-form .stepper:hover {
            border-color: color-mix(in srgb, var(--wine) 24%, var(--border));
            background-color: color-mix(in srgb, var(--card) 96%, transparent);
        }

        .reserve-form .form-control:focus,
        .reserve-form .form-select:focus,
        .reserve-form .stepper:focus-within {
            border-color: color-mix(in srgb, var(--wine) 58%, var(--border));
            box-shadow: 0 0 0 .24rem color-mix(in srgb, var(--wine) 20%, transparent);
            background-color: color-mix(in srgb, var(--card) 99%, transparent);
        }

        .reserve-form .form-select {
            background-position: right .9rem center;
            background-size: 14px 10px;
        }

        .reserve-form .form-label {
            margin-bottom: .38rem;
            letter-spacing: -.005em;
        }

        .reserve-form .form-text {
            margin-top: .38rem;
            color: color-mix(in srgb, var(--muted) 94%, var(--text));
        }

        .reserve-form .form-text {
            font-size: .86rem;
        }

        .slots-wrap {
            border-radius: 20px;
            background: linear-gradient(180deg, color-mix(in srgb, var(--card) 95%, transparent), color-mix(in srgb, var(--card) 90%, transparent));
        }

        .price-wrap {
            border-color: color-mix(in srgb, var(--wine) 24%, var(--border));
        }

        .schedule-wrap {
            border-color: color-mix(in srgb, #0f5da8 18%, var(--border));
        }

        .transfer-wrap {
            border-color: color-mix(in srgb, #179561 20%, var(--border));
        }

        .reserve-actions {
            padding-top: 8px;
            border-top: 1px dashed var(--border);
            margin-top: 8px !important;
        }

        .wizard-wrap {
            border: 1px solid var(--border);
            border-radius: 16px;
            background: color-mix(in srgb, var(--card) 95%, transparent);
            padding: 12px;
        }

        .wizard-track {
            height: 6px;
            border-radius: 999px;
            background: color-mix(in srgb, var(--card) 80%, transparent);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .wizard-bar {
            height: 100%;
            width: 25%;
            background: linear-gradient(90deg, var(--wine), var(--wine-2));
            transition: width .2s ease;
        }

        .wizard-steps {
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 8px;
        }

        .wizard-step {
            border: 1px solid var(--border);
            border-radius: 999px;
            background: color-mix(in srgb, var(--card) 92%, transparent);
            color: var(--muted);
            padding: .42rem .55rem;
            font-size: .82rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: border-color .16s ease, color .16s ease, background .16s ease;
        }

        .wizard-step.is-active,
        .wizard-step.is-done {
            color: var(--text);
            border-color: color-mix(in srgb, var(--wine) 34%, var(--border));
            background: color-mix(in srgb, var(--chip-bg) 58%, var(--card));
        }

        .form-step {
            display: none;
        }

        .form-step.is-active {
            display: block;
            animation: stepFadeIn .18s ease;
        }

        @keyframes stepFadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-card {
            border: 1px solid var(--border);
            border-radius: 18px;
            background: color-mix(in srgb, var(--card) 96%, transparent);
            padding: 14px;
        }

        .step-title {
            margin: 0 0 10px 0;
            font-size: 1.02rem;
            font-weight: 760;
            letter-spacing: -.01em;
        }

        .step-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 14px;
        }

        .confirm-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .confirm-pill {
            display: inline-flex;
            align-items: center;
            gap: .45rem;
            padding: .32rem .62rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--card) 92%, transparent);
            color: color-mix(in srgb, var(--text) 90%, var(--muted));
            font-size: .8rem;
            font-weight: 700;
            letter-spacing: .01em;
        }

        .confirm-summary {
            border-color: color-mix(in srgb, var(--wine) 22%, var(--border));
        }

        .confirm-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .confirm-item {
            border: 1px solid var(--border);
            border-radius: 14px;
            background: color-mix(in srgb, var(--card) 94%, transparent);
            padding: 10px 12px;
            min-height: 66px;
        }

        .confirm-item.total-item {
            border-color: color-mix(in srgb, var(--wine) 34%, var(--border));
            background: color-mix(in srgb, var(--chip-bg) 58%, var(--card));
        }

        .confirm-k {
            display: block;
            font-size: .78rem;
            font-weight: 700;
            color: var(--muted);
            letter-spacing: .02em;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .confirm-v {
            display: block;
            font-size: .98rem;
            font-weight: 720;
            color: var(--text);
            line-height: 1.22;
            word-break: break-word;
        }

        .confirm-v.total-value {
            font-size: 1.08rem;
        }

        .cancel-policy {
            border: 1px dashed var(--border);
            border-radius: 14px;
            padding: 10px 12px;
            background: color-mix(in srgb, var(--card) 92%, transparent);
            margin-top: 12px;
        }

        .cancel-title {
            margin: 0 0 4px 0;
            font-size: .9rem;
            font-weight: 760;
        }

        .cancel-text {
            margin: 0;
            font-size: .88rem;
            color: var(--muted);
            line-height: 1.4;
        }

        .reserve-submit {
            min-height: 46px;
            font-weight: 700;
            letter-spacing: -.01em;
            box-shadow: 0 12px 28px rgba(106, 15, 31, .24);
        }

        .reserve-cancel {
            min-height: 46px;
            font-weight: 650;
        }

        /* =========================
           Reserva - Dark mode polish
           ========================= */
        html[data-theme="dark"] main.container::before {
            background: radial-gradient(50% 150px at 10% 18%, rgba(139, 21, 48, .30), transparent 78%),
            radial-gradient(42% 160px at 90% 6%, rgba(20, 99, 173, .24), transparent 76%);
            filter: blur(4px);
        }

        html[data-theme="dark"] .reserve-hero {
            border-color: color-mix(in srgb, #8b1530 36%, var(--border));
            background: linear-gradient(125deg, color-mix(in srgb, #121420 88%, var(--card) 12%), color-mix(in srgb, var(--card) 96%, transparent)),
            radial-gradient(980px 420px at 12% -22%, rgba(139, 21, 48, .24), transparent 58%);
            box-shadow: 0 22px 44px rgba(0, 0, 0, .42);
        }

        html[data-theme="dark"] .reserve-tag {
            border-color: color-mix(in srgb, #8b1530 26%, var(--border));
            background: color-mix(in srgb, #161925 88%, var(--card));
            color: color-mix(in srgb, #ffd6de 62%, var(--text));
        }

        html[data-theme="dark"] .reserve-card {
            border-color: color-mix(in srgb, #8b1530 20%, var(--border));
            background: linear-gradient(180deg, color-mix(in srgb, #11131d 90%, var(--card) 10%), color-mix(in srgb, #0f121a 88%, var(--card) 12%));
            box-shadow: 0 20px 48px rgba(0, 0, 0, .45);
        }

        html[data-theme="dark"] .reserve-form .form-control,
        html[data-theme="dark"] .reserve-form .form-select,
        html[data-theme="dark"] .reserve-form .stepper {
            border-color: color-mix(in srgb, #233145 60%, var(--border));
            background: linear-gradient(180deg, color-mix(in srgb, #171b26 92%, var(--card)), color-mix(in srgb, #111621 94%, var(--card)));
            color: var(--text);
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, .02);
        }

        html[data-theme="dark"] .reserve-form .form-control::placeholder {
            color: color-mix(in srgb, #9fb1cb 60%, var(--muted));
            opacity: .86;
        }

        html[data-theme="dark"] .reserve-form .form-control:hover,
        html[data-theme="dark"] .reserve-form .form-select:hover,
        html[data-theme="dark"] .reserve-form .stepper:hover {
            border-color: color-mix(in srgb, #8b1530 36%, #2a3a52);
            background-color: color-mix(in srgb, #182030 90%, var(--card));
        }

        html[data-theme="dark"] .reserve-form .form-control:focus,
        html[data-theme="dark"] .reserve-form .form-select:focus,
        html[data-theme="dark"] .reserve-form .stepper:focus-within {
            border-color: color-mix(in srgb, #8b1530 56%, #2f4c74);
            box-shadow: 0 0 0 .24rem rgba(139, 21, 48, .34);
            background-color: color-mix(in srgb, #1a2131 94%, var(--card));
        }

        html[data-theme="dark"] .slots-wrap {
            border-color: color-mix(in srgb, #203047 54%, var(--border));
            background: linear-gradient(180deg, color-mix(in srgb, #121926 90%, var(--card)), color-mix(in srgb, #0f1520 88%, var(--card)));
        }

        html[data-theme="dark"] .price-wrap {
            border-color: color-mix(in srgb, #8b1530 36%, #27344b);
        }

        html[data-theme="dark"] .schedule-wrap {
            border-color: color-mix(in srgb, #1d6daf 40%, #27344b);
        }

        html[data-theme="dark"] .transfer-wrap {
            border-color: color-mix(in srgb, #179561 34%, #27344b);
        }

        html[data-theme="dark"] .transfer-item {
            border-color: color-mix(in srgb, #2a3a52 58%, var(--border));
            background: color-mix(in srgb, #131c2b 90%, var(--card));
        }

        html[data-theme="dark"] .transfer-key {
            color: color-mix(in srgb, #9eb0ca 62%, var(--muted));
        }

        html[data-theme="dark"] .transfer-tip {
            border-color: color-mix(in srgb, #2a3a52 62%, var(--border));
            background: color-mix(in srgb, #111a28 90%, var(--card));
        }

        html[data-theme="dark"] .transfer-ref {
            border-top-color: color-mix(in srgb, #2a3a52 66%, var(--border));
        }

        html[data-theme="dark"] .pill {
            border-color: color-mix(in srgb, #8b1530 38%, var(--border));
            background: color-mix(in srgb, #3f1120 54%, var(--chip-bg));
            color: #ffdfe5;
        }

        html[data-theme="dark"] .slot-pill {
            border-color: color-mix(in srgb, #253349 58%, var(--border));
            background: color-mix(in srgb, #151c2a 92%, var(--card));
        }

        html[data-theme="dark"] .slot-pill:hover {
            border-color: color-mix(in srgb, #8b1530 44%, #2f4669);
            background: color-mix(in srgb, #1a2233 88%, var(--card));
        }

        html[data-theme="dark"] .slot-pill .mini {
            border-color: color-mix(in srgb, #253349 56%, var(--border));
            background: color-mix(in srgb, #111a29 90%, var(--card));
            color: color-mix(in srgb, #b2c2d9 66%, var(--muted));
        }

        html[data-theme="dark"] .tbtn {
            border-color: color-mix(in srgb, #253349 58%, var(--border));
            background: color-mix(in srgb, #151d2c 90%, var(--card));
        }

        html[data-theme="dark"] .tbtn:hover {
            border-color: color-mix(in srgb, #8b1530 40%, #2f4669);
            background: color-mix(in srgb, #1a2335 90%, var(--card));
        }

        html[data-theme="dark"] .tbtn-ic {
            border-color: color-mix(in srgb, #263750 58%, var(--border));
            background: color-mix(in srgb, #121a29 92%, var(--card));
        }

        html[data-theme="dark"] #onlineWrap .alert-info {
            color: #d6ebff;
            border-color: color-mix(in srgb, #1d6daf 44%, var(--border));
            background: linear-gradient(180deg, rgba(29, 109, 175, .18), rgba(29, 109, 175, .10));
        }

        html[data-theme="dark"] .reserve-actions {
            border-top-color: color-mix(in srgb, #2a3a52 66%, var(--border));
        }

        html[data-theme="dark"] .reserve-submit {
            box-shadow: 0 12px 30px rgba(139, 21, 48, .34);
        }

        html[data-theme="dark"] .wizard-wrap,
        html[data-theme="dark"] .step-card {
            border-color: color-mix(in srgb, #2a3a52 56%, var(--border));
            background: color-mix(in srgb, #121826 90%, var(--card));
        }

        html[data-theme="dark"] .wizard-track {
            border-color: color-mix(in srgb, #2a3a52 56%, var(--border));
            background: color-mix(in srgb, #0f1522 92%, var(--card));
        }

        html[data-theme="dark"] .wizard-step {
            border-color: color-mix(in srgb, #2a3a52 58%, var(--border));
            background: color-mix(in srgb, #121a2a 92%, var(--card));
            color: color-mix(in srgb, #a7b8d1 62%, var(--muted));
        }

        html[data-theme="dark"] .wizard-step.is-active,
        html[data-theme="dark"] .wizard-step.is-done {
            border-color: color-mix(in srgb, #8b1530 40%, #2a3a52);
            background: color-mix(in srgb, #3b1220 58%, #121a2a);
            color: #ffe0e7;
        }

        html[data-theme="dark"] .confirm-pill {
            border-color: color-mix(in srgb, #2a3a52 56%, var(--border));
            background: color-mix(in srgb, #131b2b 90%, var(--card));
            color: color-mix(in srgb, #aec0d8 64%, var(--muted));
        }

        html[data-theme="dark"] .confirm-summary {
            border-color: color-mix(in srgb, #8b1530 36%, #2a3a52);
        }

        html[data-theme="dark"] .confirm-item {
            border-color: color-mix(in srgb, #2a3a52 58%, var(--border));
            background: color-mix(in srgb, #111a2a 92%, var(--card));
        }

        html[data-theme="dark"] .confirm-item.total-item {
            border-color: color-mix(in srgb, #8b1530 40%, #2a3a52);
            background: color-mix(in srgb, #3b1220 58%, #121a2a);
        }

        html[data-theme="dark"] .confirm-k {
            color: color-mix(in srgb, #9fb2cc 66%, var(--muted));
        }

        html[data-theme="dark"] .cancel-policy {
            border-color: color-mix(in srgb, #2a3a52 62%, var(--border));
            background: color-mix(in srgb, #101928 92%, var(--card));
        }

        html[data-theme="dark"] .cancel-text {
            color: color-mix(in srgb, #a4b8d2 68%, var(--muted));
        }

        @media (max-width: 768px) {
            .reserve-card {
                padding: 1rem !important;
            }

            .wizard-steps {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .transfer-grid {
                grid-template-columns: 1fr;
            }

            .confirm-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .form-step.is-active {
                animation: none;
            }
        }

    </style>

    <!-- ‚úÖ Inyecto pricing sin romper el JS del editor -->
    <script id="pricingJson" type="application/json"><%- JSON.stringify(
                (typeof pricing !== "undefined" && pricing) ? pricing : {
                    passenger_price_mxn: 120,
                    package_price_mxn: 120
                }
        ) %></script>
</head>

<body>
<%- include('partials/body-open') %>
<nav class="navbar navbar-dark app-navbar">
    <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/">
            <span class="brand-dot"></span>
            <span class="fw-bold">TransportApp</span>
        </a>

        <button id="themeToggle" class="theme-btn" type="button" aria-label="Cambiar tema">
            <span id="themeIcon">üåô</span> <span class="d-none d-sm-inline">Tema</span>
        </button>
    </div>
</nav>

<main class="container py-4">

    <div class="hero reserve-hero mb-3">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
            <div>
                <h1 class="h3 headline mb-1">Reservar</h1>
                <div class="subtle">Elige ruta, fecha y cantidad. Te mostramos solo horarios con cupo.</div>
                <div class="reserve-tags">
                    <span class="reserve-tag">Proceso guiado</span>
                    <span class="reserve-tag">Confirmaci√≥n inmediata</span>
                    <span class="reserve-tag">Hasta 6 pasajeros</span>
                </div>
            </div>
            <a class="btn btn-wine" href="/">Volver</a>
        </div>
    </div>

    <div class="card-soft reserve-card p-4">
        <% if (error) { %>
            <div class="alert alert-danger mb-3"><%= error %></div>
        <% } %>

            <form id="reserveForm" method="POST" action="/reserve" class="reserve-form row g-3" novalidate>
                <div class="col-12">
                    <div class="wizard-wrap">
                        <div class="wizard-track" aria-hidden="true">
                            <div id="wizardBar" class="wizard-bar"></div>
                        </div>
                        <div class="wizard-steps" role="tablist" aria-label="Progreso de la reserva">
                            <button type="button" class="wizard-step is-active" data-step-target="1">1. Viaje</button>
                            <button type="button" class="wizard-step" data-step-target="2">2. Contacto</button>
                            <button type="button" class="wizard-step" data-step-target="3">3. Pago</button>
                            <button type="button" class="wizard-step" data-step-target="4">4. Confirmar</button>
                        </div>
                    </div>
                </div>

                <div class="col-12 form-step is-active" data-step="1">
                    <div class="step-card">
                        <h2 class="step-title">Ruta y horario</h2>
                        <div class="row g-3">
                            <!-- 1) Origen -->
                            <div class="col-md-6">
                                <label class="form-label">¬øDe d√≥nde sales?</label>
                                <select id="from_city" class="form-select" required>
                                    <option value="VIC" selected>Ciudad Victoria</option>
                                    <option value="LLE">Llera</option>
                                </select>
                            </div>

                            <!-- 2) Destino -->
                            <div class="col-md-6">
                                <label class="form-label">¬øHacia d√≥nde vas?</label>
                                <select id="to_city" class="form-select" required>
                                    <option value="LLE" selected>Llera</option>
                                    <option value="VIC">Ciudad Victoria</option>
                                </select>
                            </div>

                            <input type="hidden" id="direction" name="direction" value="VIC_TO_LLE">

                            <!-- 3) Fecha -->
                            <div class="col-md-4">
                                <label class="form-label">¬øCu√°ndo viajas?</label>
                                <input id="trip_date" name="trip_date" type="date" class="form-control" required/>
                                <div class="form-text subtle">Por defecto se coloca el d√≠a de hoy.</div>
                            </div>

                            <!-- 4) Tipo -->
                            <div class="col-md-4">
                                <label class="form-label">¬øQu√© quieres reservar?</label>
                                <select id="type" name="type" class="form-select" required>
                                    <option value="PASSENGER" selected>Pasajero</option>
                                    <option value="PACKAGE">Paqueter√≠a</option>
                                </select>
                            </div>

                            <!-- 5) Cu√°ntos viajan -->
                            <div class="col-md-4" id="seatsWrap">
                                <label class="form-label">¬øCu√°ntos viajan?</label>

                                <div class="stepper">
                                    <button id="minusBtn" type="button" class="btn-step" aria-label="Disminuir">‚àí
                                    </button>
                                    <div class="count"><span id="seatsText">1</span></div>
                                    <button id="plusBtn" type="button" class="btn-step" aria-label="Aumentar">+</button>

                                    <!-- ‚úÖ SOLO 1‚Äì6 -->
                                    <select id="seats" name="seats" class="d-none">
                                        <option value="1" selected>1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                    </select>
                                </div>

                                <div class="form-text subtle">M√°ximo 6 pasajeros por salida.</div>
                            </div>

                            <!-- PAQUETER√çA -->
                            <div class="col-12" id="packageWrap">
                                <label class="form-label">Detalle paqueter√≠a (obligatorio)</label>
                                <input id="package_details" name="package_details" class="form-control"
                                       placeholder="Ej: sobre, refacciones, etc."/>
                            </div>

                            <!-- Horarios -->
                            <div class="col-12">
                                <label class="form-label">Hora (seg√∫n cupo)</label>
                                <input type="hidden" id="depart_time" name="depart_time" value="">

                                <div class="slots-wrap schedule-wrap">
                                    <div class="slots-head">
                                        <p class="slots-title mb-0">Horarios disponibles</p>
                                        <div class="slots-sub" id="slotsHint">Selecciona fecha y ruta.</div>
                                    </div>

                                    <div id="slotsLoading" class="help">‚Äî</div>

                                    <div id="sections" class="d-none">
                                        <div class="slot-section" id="morningSection">
                                            <div class="section-label">üå§Ô∏è Ma√±ana</div>
                                            <div id="morningSlots" class="slots"></div>
                                        </div>

                                        <div class="slot-section" id="afternoonSection">
                                            <div class="section-label">üåá Tarde</div>
                                            <div id="afternoonSlots" class="slots"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-text subtle mt-2">Te mostramos horarios con cupo para tu selecci√≥n.
                                </div>
                                <div id="departTimeError" class="step-inline-error d-none"></div>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button type="button" class="btn btn-wine px-4" data-next-step>Siguiente</button>
                        </div>
                    </div>
                </div>

                <div class="col-12 form-step" data-step="2">
                    <div class="step-card">
                        <h2 class="step-title">Datos de contacto</h2>
                        <div class="row g-3">
                            <!-- ‚úÖ CONTACTO (SIEMPRE) -->
                            <div class="col-md-6" id="contactNameWrap">
                                <label class="form-label">Nombre de contacto</label>
                                <input id="customer_name" name="customer_name" class="form-control" required
                                       placeholder="Ej: Juan Mart√≠nez"/>
                                <div class="form-text subtle">
                                    Usaremos este nombre para tu reserva y para contactarte.
                                </div>
                            </div>

                            <!-- Tel√©fono -->
                            <div class="col-md-6">
                                <label class="form-label">Tel√©fono</label>
                                <input id="phone" name="phone" class="form-control" required
                                       inputmode="numeric" pattern="[0-9]{10}" placeholder="Ej: 8344756376"/>
                                <div class="invalid-feedback">Ingresa un tel√©fono v√°lido (10 d√≠gitos).</div>
                            </div>

                            <!-- ‚úÖ PASAJEROS (OPCIONAL) -->
                            <div class="col-12" id="passengerNamesWrap">
                                <div class="form-check form-switch m-0 names-toggle" id="namesToggleWrap">
                                    <input class="form-check-input" type="checkbox" id="namesToggle">
                                    <label class="form-check-label subtle" for="namesToggle">Capturar nombres</label>
                                </div>

                                <div class="form-text subtle mt-1">
                                    Puedes omitir los nombres y solo usar el contacto.
                                </div>

                                <div id="passengerNamesBox" class="mt-2 d-none">
                                    <div id="passengerNames" class="row g-2"></div>
                                    <div class="form-text">
                                        Si activas esta opci√≥n, capturamos un nombre por asiento.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button type="button" class="btn btn-outline-secondary px-4" data-prev-step>Anterior
                            </button>
                            <button type="button" class="btn btn-wine px-4" data-next-step>Siguiente</button>
                    </div>
                </div>
            </div>

                <div class="col-12 form-step" data-step="3">
                    <div class="step-card">
                        <h2 class="step-title">Pago</h2>
                        <div class="row g-3">
                            <!-- M√âTODO DE PAGO -->
                            <div class="col-md-6">
                                <label class="form-label">M√©todo de pago</label>
                                <select id="payment_method" name="payment_method" class="form-select" required>
                                    <option value="TAQUILLA" selected>Taquilla</option>
                                    <option value="TRANSFERENCIA">Transferencia</option>
                                    <option value="ONLINE">Pago en l√≠nea</option>
                                </select>
                                <div class="form-text subtle">Elige c√≥mo deseas pagar tu reserva.</div>
                            </div>

                            <!-- TOTAL A PAGAR -->
                            <div class="col-12">
                                <div class="slots-wrap price-wrap">
                                    <div class="slots-head">
                                        <p class="slots-title mb-0">Total a pagar</p>
                                        <div class="slots-sub" id="priceHint">Cargando precio‚Ä¶</div>
                                    </div>

                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <span class="pill">üí∞ <span id="priceTotal">$0</span></span>
                                        <span class="help" id="priceBreakdown"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- TRANSFERENCIA -->
                            <div class="col-12 d-none" id="transferWrap">
                                <div class="slots-wrap transfer-wrap">
                                    <div class="slots-head">
                                        <p class="slots-title mb-0">Datos para transferencia</p>
                                        <div class="slots-sub">Transfiere y comparte el comprobante por WhatsApp.</div>
                                    </div>

                                    <div class="transfer-grid" aria-label="Datos bancarios">
                                        <div class="transfer-item">
                                            <span class="transfer-key">Banco</span>
                                            <span class="transfer-value" id="bankName">BBVA</span>
                                        </div>
                                        <div class="transfer-item">
                                            <span class="transfer-key">Beneficiario</span>
                                            <span class="transfer-value" id="bankOwner">Gary Trevi√±o</span>
                                        </div>
                                        <div class="transfer-item">
                                            <span class="transfer-key">Numero de tarjeta</span>
                                            <span class="transfer-value mono" id="bankClabe">4152 3142 8477 3416</span>
                                        </div>
                                    </div>

                                    <div class="transfer-actions">
                                        <button type="button" class="tbtn" id="copyClabeBtn"
                                                aria-label="Copiar n√∫mero de tarjeta">
                                        <span class="tbtn-ic" aria-hidden="true">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                 stroke-linecap="round" stroke-linejoin="round">
                                                <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                            </svg>
                                        </span>
                                            <span class="tbtn-txt">Copiar tarjeta</span>
                                        </button>

                                        <button type="button" class="tbtn" id="copyTransferMsgBtn"
                                                aria-label="Copiar mensaje de transferencia">
                                        <span class="tbtn-ic" aria-hidden="true">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                 stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                            </svg>
                                        </span>
                                            <span class="tbtn-txt">Copiar mensaje</span>
                                        </button>
                                    </div>

                                    <div class="transfer-tip">
                                        <strong>Concepto sugerido:</strong> ‚ÄúServicio de transporte‚Äù
                                        <span class="subtle">(tu folio se genera al finalizar)</span>.
                                        <br>
                                        Despu√©s, env√≠anos el comprobante por WhatsApp para confirmar.
                                    </div>

                                    <div class="transfer-ref d-none">
                                        <label class="form-label">Referencia / folio de transferencia (opcional)</label>
                                        <input id="transfer_ref" name="transfer_ref" class="form-control"
                                               placeholder="Ej: 123456 / SPEI / concepto"/>
                                        <div class="form-text subtle">
                                            Si ya hiciste la transferencia, pega aqu√≠ la referencia. Si no, puedes
                                            dejarlo vac√≠o.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ONLINE: aviso -->
                            <div class="col-12 d-none" id="onlineWrap">
                                <div class="alert alert-info mb-0">
                                    <strong>Pago en l√≠nea:</strong> al confirmar la reserva te llevaremos al pago del
                                    pasaje.
                                </div>
                            </div>
                        </div>
                        <div class="step-actions">
                            <button type="button" class="btn btn-outline-secondary px-4" data-prev-step>Anterior
                            </button>
                            <button type="button" class="btn btn-wine px-4" data-next-step>Siguiente</button>
                        </div>
                    </div>
            </div>

                <div class="col-12 form-step" data-step="4">
                    <div class="step-card">
                        <div class="confirm-head">
                            <h2 class="step-title mb-0">Confirmaci√≥n</h2>
                            <span class="confirm-pill">Revisa antes de enviar</span>
                        </div>
                        <div class="slots-wrap confirm-summary">
                            <div class="slots-head">
                                <p class="slots-title mb-0">Resumen de la reserva</p>
                            </div>
                            <div class="confirm-grid">
                                <div class="confirm-item">
                                    <span class="confirm-k">Ruta</span>
                                    <span class="confirm-v" id="sumRoute">-</span>
                                </div>
                                <div class="confirm-item">
                                    <span class="confirm-k">Fecha</span>
                                    <span class="confirm-v" id="sumDate">-</span>
                                </div>
                                <div class="confirm-item">
                                    <span class="confirm-k">Hora</span>
                                    <span class="confirm-v" id="sumTime">-</span>
                                </div>
                                <div class="confirm-item">
                                    <span class="confirm-k">Tipo</span>
                                    <span class="confirm-v" id="sumType">-</span>
                                </div>
                                <div class="confirm-item">
                                    <span class="confirm-k">Pasajeros</span>
                                    <span class="confirm-v" id="sumSeats">-</span>
                                </div>
                                <div class="confirm-item">
                                    <span class="confirm-k">Pago</span>
                                    <span class="confirm-v" id="sumPayment">-</span>
                                </div>
                                <div class="confirm-item total-item">
                                    <span class="confirm-k">Total</span>
                                    <span class="confirm-v total-value" id="sumTotal">-</span>
                                </div>
                                <div class="confirm-item">
                                    <span class="confirm-k">Contacto</span>
                                    <span class="confirm-v" id="sumContact">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="cancel-policy">
                            <p class="cancel-title">Pol√≠tica de cancelaci√≥n</p>
                            <p class="cancel-text">Env√≠a tu ticket con al menos 1 hora de anticipaci√≥n para solicitar
                                devoluci√≥n.</p>
                        </div>

                        <div class="step-actions reserve-actions">
                            <button type="button" class="btn btn-outline-secondary px-4" data-prev-step>Anterior
                            </button>
                            <button class="btn btn-wine px-4 reserve-submit">Confirmar reserva</button>
                            <a class="btn btn-outline-secondary px-4 reserve-cancel" href="/">Cancelar</a>
                        </div>
                    </div>
            </div>
        </form>
    </div>

</main>

<%- include('partials/toast') %>
<%- include('partials/footer') %>

<script>
    const tripDate = document.getElementById("trip_date");

    const fromCity = document.getElementById("from_city");
    const toCity = document.getElementById("to_city");
    const directionInput = document.getElementById("direction");

    const typeSel = document.getElementById("type");

    const seatsWrap = document.getElementById("seatsWrap");
    const seatsSel = document.getElementById("seats");
    const seatsText = document.getElementById("seatsText");
    const plusBtn = document.getElementById("plusBtn");
    const minusBtn = document.getElementById("minusBtn");

    const customerName = document.getElementById("customer_name");

    const passengerNamesWrap = document.getElementById("passengerNamesWrap");
    const passengerNamesBox = document.getElementById("passengerNamesBox");
    const passengerNames = document.getElementById("passengerNames");
    const namesToggleWrap = document.getElementById("namesToggleWrap");
    const namesToggle = document.getElementById("namesToggle");

    const paymentMethod = document.getElementById("payment_method");
    const transferWrap = document.getElementById("transferWrap");
    const onlineWrap = document.getElementById("onlineWrap");

    const packageWrap = document.getElementById("packageWrap");
    const packageDetails = document.getElementById("package_details");

    const departTimeHidden = document.getElementById("depart_time");
    const departTimeError = document.getElementById("departTimeError");

    const slotsHint = document.getElementById("slotsHint");
    const slotsLoading = document.getElementById("slotsLoading");
    const sections = document.getElementById("sections");
    const morningSection = document.getElementById("morningSection");
    const afternoonSection = document.getElementById("afternoonSection");
    const morningSlots = document.getElementById("morningSlots");
    const afternoonSlots = document.getElementById("afternoonSlots");

    const priceTotal = document.getElementById("priceTotal");
    const priceBreakdown = document.getElementById("priceBreakdown");
    const priceHint = document.getElementById("priceHint");

    const copyClabeBtn = document.getElementById("copyClabeBtn");
    const copyTransferMsgBtn = document.getElementById("copyTransferMsgBtn");
    const bankClabeEl = document.getElementById("bankClabe");

    const formEl = document.getElementById("reserveForm");
    const stepPanels = [...document.querySelectorAll(".form-step")];
    const stepDots = [...document.querySelectorAll(".wizard-step")];
    const wizardBar = document.getElementById("wizardBar");

    const TOTAL_STEPS = 4;
    let currentStep = 1;
    let maxReachedStep = 1;
    const DRAFT_KEY = "reserve_form_draft_v1";
    let restoredStep = 1;
    let restoredPassengerNames = [];

    // ‚úÖ I use this to preselect direction/time coming from the index chips (/reserve?dir=...&time=...)
    let PREFERRED_TIME = null;

    // ‚úÖ pricing inicial desde server (sin romper el JS del editor)
    function parsePricingFromServer() {
        try {
            const el = document.getElementById("pricingJson");
            const raw = el ? el.textContent : "{}";
            const obj = JSON.parse(raw || "{}");
            return {
                passenger_price_mxn: Number(obj?.passenger_price_mxn ?? 120),
                package_price_mxn: Number(obj?.package_price_mxn ?? 120),
            };
        } catch {
            return {passenger_price_mxn: 120, package_price_mxn: 120};
        }
    }

    let PRICING = parsePricingFromServer();
    let PRICING_OK = true;

    function readDraft() {
        try {
            const raw = localStorage.getItem(DRAFT_KEY);
            if (!raw) return null;
            const draft = JSON.parse(raw);
            return draft && typeof draft === "object" ? draft : null;
        } catch {
            return null;
        }
    }

    function writeDraft() {
        try {
            const passengerInputs = [...document.querySelectorAll("#passengerNames input[name='passenger_names[]']")];
            const draft = {
                step: currentStep,
                from_city: fromCity.value || "",
                to_city: toCity.value || "",
                trip_date: tripDate.value || "",
                type: typeSel.value || "PASSENGER",
                seats: seatsSel.value || "1",
                customer_name: customerName.value || "",
                phone: document.getElementById("phone")?.value || "",
                names_toggle: !!namesToggle?.checked,
                passenger_names: passengerInputs.map((x) => x.value || ""),
                payment_method: paymentMethod.value || "TAQUILLA",
                package_details: packageDetails.value || "",
                transfer_ref: document.getElementById("transfer_ref")?.value || "",
                depart_time: departTimeHidden.value || ""
            };

            localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
        } catch {
            // no-op
        }
    }

    function clearDraft() {
        try {
            localStorage.removeItem(DRAFT_KEY);
        } catch {
            // no-op
        }
    }

    function restoreDraft() {
        const draft = readDraft();
        if (!draft) return false;

        if (draft.from_city) fromCity.value = String(draft.from_city);
        if (draft.to_city) toCity.value = String(draft.to_city);
        if (draft.trip_date) tripDate.value = String(draft.trip_date);
        if (draft.type) typeSel.value = String(draft.type);
        if (draft.seats) seatsSel.value = String(draft.seats);
        if (typeof draft.customer_name === "string") customerName.value = draft.customer_name;

        const phoneEl = document.getElementById("phone");
        if (phoneEl && typeof draft.phone === "string") phoneEl.value = draft.phone;

        if (namesToggle && typeof draft.names_toggle === "boolean") namesToggle.checked = draft.names_toggle;

        if (paymentMethod && draft.payment_method) paymentMethod.value = String(draft.payment_method);
        if (typeof draft.package_details === "string") packageDetails.value = draft.package_details;

        const transferRefEl = document.getElementById("transfer_ref");
        if (transferRefEl && typeof draft.transfer_ref === "string") transferRefEl.value = draft.transfer_ref;

        if (typeof draft.depart_time === "string" && draft.depart_time) {
            departTimeHidden.value = draft.depart_time;
            PREFERRED_TIME = draft.depart_time;
        }

        restoredPassengerNames = Array.isArray(draft.passenger_names) ? draft.passenger_names.map((x) => String(x || "")) : [];
        restoredStep = Math.max(1, Math.min(TOTAL_STEPS, Number(draft.step || 1)));
        return true;
    }

    function todayISO() {
        return new Date().toLocaleDateString("en-CA", {timeZone: "America/Monterrey"});
    }

    function nowHHMM_MTY() {
        // I get current time in Monterrey in 24h HH:MM
        return new Date().toLocaleTimeString("en-GB", {
            timeZone: "America/Monterrey",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
        });
    }

    function isTodaySelected() {
        return (tripDate.value || "") === todayISO();
    }


    async function loadPricing() {
        // I refresh pricing from /pricing, but I already have a server-side default.
        try {
            const res = await fetch("/pricing", {headers: {"Accept": "application/json"}});
            const data = await res.json();

            if (data?.ok) {
                PRICING = {
                    passenger_price_mxn: Number(data.passenger_price_mxn ?? PRICING.passenger_price_mxn ?? 120),
                    package_price_mxn: Number(data.package_price_mxn ?? PRICING.package_price_mxn ?? 120),
                };
                PRICING_OK = true;
            } else {
                PRICING_OK = false;
            }
        } catch {
            PRICING_OK = false;
        } finally {
            updatePriceUI();
        }
    }

    function toHHMM(t) {
        const s = String(t || "").trim();
        const parts = s.split(":");
        if (parts.length >= 2) return `${parts[0].padStart(2, "0")}:${parts[1].padStart(2, "0")}`;
        return s;
    }

    function hourFromTime(t) {
        const hhmm = toHHMM(t);
        const hh = Number((hhmm.split(":")[0] || "0"));
        return isNaN(hh) ? 0 : hh;
    }

    function setSeats(n) {
        const value = Math.max(1, Math.min(6, Number(n || 1)));
        seatsSel.value = String(value);
        seatsText.textContent = String(value);

        minusBtn.disabled = value <= 1;
        plusBtn.disabled = value >= 6;

        updatePriceUI();
        updateSummary();
        writeDraft();
    }

    function syncDirection() {
        const f = fromCity.value;
        const t = toCity.value;

        if (f === t) toCity.value = (f === "VIC") ? "LLE" : "VIC";

        const from = fromCity.value;
        const to = toCity.value;

        directionInput.value = (from === "VIC" && to === "LLE") ? "VIC_TO_LLE" : "LLE_TO_VIC";
        updateSummary();
        writeDraft();
    }

    function applyPrefillFromQuery() {
        try {
            const qs = new URLSearchParams(window.location.search);

            const dir = (qs.get("dir") || qs.get("direction") || "").trim().toUpperCase();
            const timeRaw = (qs.get("time") || qs.get("depart_time") || "").trim();
            const date = (qs.get("date") || qs.get("trip_date") || "").trim();

            // Normalizo HH:MM (si viene 6:30 => 06:30)
            const time = timeRaw ? toHHMM(timeRaw) : "";

            // Aplico direcci√≥n a selects (para que syncDirection() ya deje bien el hidden)
            if (dir === "VIC_TO_LLE") {
                fromCity.value = "VIC";
                toCity.value = "LLE";
            } else if (dir === "LLE_TO_VIC") {
                fromCity.value = "LLE";
                toCity.value = "VIC";
            }

            // Fecha (YYYY-MM-DD)
            if (date) {
                tripDate.value = date;
            }

            // Hora preferida para seleccionar al renderizar slots
            if (time) {
                PREFERRED_TIME = time; // ya viene en HH:MM
            }

            // ‚úÖ Limpio URL (solo est√©tica) sin recargar
            if (dir || time || date) {
                const clean = new URL(window.location.href);

                if (dir) clean.searchParams.set("dir", dir);
                if (time) clean.searchParams.set("time", time);
                else clean.searchParams.delete("time");

                if (date) clean.searchParams.set("date", date);
                else clean.searchParams.delete("date");

                clean.searchParams.delete("direction");
                clean.searchParams.delete("depart_time");
                clean.searchParams.delete("trip_date");

                window.history.replaceState({}, "", clean.toString());
            }
        } catch {
            // no-op
        }
    }

    function namesEnabled() {
        return !!namesToggle?.checked;
    }

    function updateUIByType() {
        const isPassenger = typeSel.value === "PASSENGER";

        seatsWrap.style.display = isPassenger ? "" : "none";

        // I show the "capture names" switch only for passengers.
        namesToggleWrap.style.display = isPassenger ? "" : "none";

        // I show/hide package detail.
        packageWrap.style.display = isPassenger ? "none" : "";

        // I enforce package details only for packages.
        if (!isPassenger) {
            packageDetails.setAttribute("required", "required");

            // I disable passenger names when switching to package.
            if (namesToggle) namesToggle.checked = false;
            passengerNames.innerHTML = "";
            passengerNamesBox.classList.add("d-none");
        } else {
            packageDetails.value = "";
            packageDetails.removeAttribute("required");
        }

        updatePriceUI();
        renderPassengerInputs();
        updateSummary();
        writeDraft();
    }

    function updateUIByPayment() {
        const m = paymentMethod.value;
        const isTransfer = m === "TRANSFERENCIA";
        const isOnline = m === "ONLINE";

        transferWrap.classList.toggle("d-none", !isTransfer);
        onlineWrap.classList.toggle("d-none", !isOnline);
        updateSummary();
        writeDraft();
    }

    function renderPassengerInputs() {
        const isPassenger = typeSel.value === "PASSENGER";
        const seats = Number(seatsSel.value || 1);

        passengerNames.innerHTML = "";

        // I only render passenger name inputs if the user explicitly wants them.
        if (!isPassenger || !namesEnabled()) {
            passengerNamesBox.classList.add("d-none");
            return;
        }

        passengerNamesBox.classList.remove("d-none");

        for (let i = 1; i <= seats; i++) {
            const col = document.createElement("div");
            col.className = "col-md-4";
            const input = document.createElement("input");
            input.className = "form-control";
            input.name = "passenger_names[]";
            input.required = true;
            input.placeholder = `Pasajero ${i} (Nombre completo)`;
            input.value = restoredPassengerNames[i - 1] || "";
            input.addEventListener("input", writeDraft);
            col.appendChild(input);
            passengerNames.appendChild(col);
        }

        restoredPassengerNames = [];
    }

    function clearSlotsUI(msg) {
        departTimeHidden.value = "";
        clearDepartTimeError();
        slotsLoading.textContent = msg || "Selecciona fecha y ruta para ver horarios.";
        sections.classList.add("d-none");
        morningSlots.innerHTML = "";
        afternoonSlots.innerHTML = "";
        morningSection.classList.remove("d-none");
        afternoonSection.classList.remove("d-none");
    }

    function setSelectedTime(hhmm) {
        const value = toHHMM(hhmm);
        departTimeHidden.value = value;
        clearDepartTimeError();

        document.querySelectorAll(".slot-pill").forEach(el => {
            el.setAttribute("aria-selected", (el.dataset.time === value) ? "true" : "false");
        });
        updateSummary();
        writeDraft();
    }

    function createPill({time, available, seatsNeeded}) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "slot-pill";
        const hhmm = toHHMM(time);
        btn.dataset.time = hhmm;
        btn.setAttribute("aria-selected", "false");

        if (seatsNeeded > 0) {
            if (available <= 2) btn.classList.add("is-warning");
            if (available <= 0) btn.classList.add("is-danger");
        }

        const extra = (seatsNeeded > 0)
            ? `<span class="mini">para ${seatsNeeded}</span>`
            : `<span class="mini">Paqueter√≠a</span>`;

        btn.innerHTML = `
            <span class="time">üïí ${hhmm}</span>
            <span class="mini">üë• ${available} libres</span>
            ${extra}
        `;

        btn.addEventListener("click", () => setSelectedTime(hhmm));
        return btn;
    }

    function renderSlotsGrouped(results, seatsNeeded) {
        const requiresCapacity = seatsNeeded > 0;

        const nowHHMM = nowHHMM_MTY();
        const filterPast = isTodaySelected(); // only hide past times if date is today

        const items = (results || [])
            .map(x => ({time: toHHMM(x.time), available: Number(x.available || 0)}))
            .filter(x => requiresCapacity ? (x.available >= seatsNeeded) : true)
            // ‚úÖ hide past slots (today only)
            .filter(x => !filterPast || x.time > nowHHMM)
            .sort((a, b) => a.time.localeCompare(b.time));


        if (!items.length) {
            const msg = (filterPast)
                ? "Ya no hay horarios disponibles para hoy. Elige otra fecha."
                : (requiresCapacity
                    ? "No hay horarios con cupo suficiente para tu selecci√≥n."
                    : "No hay horarios para esta fecha/ruta.");

            clearSlotsUI(msg);
            return;
        }


        const morning = items.filter(x => hourFromTime(x.time) < 12);
        const afternoon = items.filter(x => hourFromTime(x.time) >= 12);

        morningSlots.innerHTML = "";
        afternoonSlots.innerHTML = "";

        if (!morning.length) morningSection.classList.add("d-none"); else morningSection.classList.remove("d-none");
        if (!afternoon.length) afternoonSection.classList.add("d-none"); else afternoonSection.classList.remove("d-none");

        morning.forEach(x => morningSlots.appendChild(createPill({...x, seatsNeeded})));
        afternoon.forEach(x => afternoonSlots.appendChild(createPill({...x, seatsNeeded})));

        sections.classList.remove("d-none");
        slotsLoading.textContent = "Selecciona un horario:";

        // ‚úÖ If I have a preferred time from the index, I try to select it.
        const preferred = PREFERRED_TIME ? toHHMM(PREFERRED_TIME) : null;
        const found = preferred ? items.find(x => x.time === preferred) : null;

        const initial = (found ? found.time : (morning[0] || afternoon[0]).time);
        setSelectedTime(initial);

        // ‚úÖ I clear preferred time after it successfully matches, so later reloads behave normal.
        if (found) PREFERRED_TIME = null;
    }

    async function loadAvailability() {
        const date = tripDate.value;
        const dir = directionInput.value;

        if (!date || !dir) {
            clearSlotsUI("Selecciona fecha y ruta para ver horarios.");
            return;
        }

        const seatsNeeded = (typeSel.value === "PASSENGER")
            ? Number(seatsSel.value || 1)
            : 0;

        slotsLoading.textContent = "Cargando horarios...";
        sections.classList.add("d-none");
        departTimeHidden.value = "";

        try {
            const url = `/availability?date=${encodeURIComponent(date)}&direction=${encodeURIComponent(dir)}&seats=${encodeURIComponent(seatsNeeded)}`;
            const res = await fetch(url);
            const data = await res.json();

            renderSlotsGrouped(data.results || [], seatsNeeded);
        } catch (e) {
            clearSlotsUI("Error al cargar horarios. Intenta de nuevo.");
        }
    }

    function formatMXN(n) {
        const v = Number(n || 0);
        return `$${v.toFixed(2)} MXN`;
    }

    function buildTransferMessage() {
        const bank = document.getElementById("bankName")?.textContent?.trim() || "";
        const owner = document.getElementById("bankOwner")?.textContent?.trim() || "";
        const card = document.getElementById("bankClabe")?.textContent?.trim() || "";

        const dir = (directionInput.value === "VIC_TO_LLE") ? "Victoria - Llera" : "Llera - Victoria";
        const date = tripDate.value || "-";
        const time = departTimeHidden.value || "(sin horario a√∫n)";
        const type = (typeSel.value === "PASSENGER") ? "Pasaje" : "Paqueter√≠a";
        const seats = Number(seatsSel.value || 1);

        const totalText = priceTotal?.textContent || "";
        const contact = (customerName?.value || "").trim();

        return [
            "Datos para transferencia (TransportApp)",
            "--------------------------------------",
            `Banco: ${bank}`,
            `Beneficiario: ${owner}`,
            `N√∫mero de tarjeta: ${card}`,
            "",
            "Datos de mi reserva",
            "-------------------",
            `Contacto: ${contact || "-"}`,
            `Ruta: ${dir}`,
            `Fecha: ${date}`,
            `Hora: ${time}`,
            `Tipo: ${type}${typeSel.value === "PASSENGER" ? ` (${seats} pasajero(s))` : ""}`,
            `Total: ${totalText}`,
            "",
            "Nota: El folio se genera al finalizar la reserva."
        ].join("\n");
    }

    copyClabeBtn?.addEventListener("click", async () => {
        try {
            const rawCard = bankClabeEl?.textContent?.trim() || "";
            const cardNoSpaces = rawCard.replace(/\s+/g, "").replace(/-/g, "");
            await navigator.clipboard.writeText(cardNoSpaces);
            notify("N√∫mero de tarjeta copiado", {variant: "success"});
        } catch {
            notify("No pude copiar el n√∫mero. Selecci√≥nalo manualmente.", {variant: "danger", delay: 2500});
        }
    });

    copyTransferMsgBtn?.addEventListener("click", async () => {
        try {
            await navigator.clipboard.writeText(buildTransferMessage());
            notify("Mensaje copiado", {variant: "success"});
        } catch {
            notify("No pude copiar el mensaje. Intenta de nuevo.", {variant: "danger", delay: 2500});
        }
    });

    function updatePriceUI() {
        const isPassenger = typeSel.value === "PASSENGER";
        const seats = Number(seatsSel.value || 1);

        const unit = isPassenger
            ? Number(PRICING.passenger_price_mxn || 0)
            : Number(PRICING.package_price_mxn || 0);

        const total = isPassenger ? (unit * seats) : unit;

        priceTotal.textContent = formatMXN(total);

        if (isPassenger) {
            priceBreakdown.textContent = `${formatMXN(unit)} x ${seats} pasajero(s)`;
            priceHint.textContent = PRICING_OK ? "Pasaje (precio actual)" : "Pasaje (estimado)";
        } else {
            priceBreakdown.textContent = `${formatMXN(unit)} (costo fijo)`;
            priceHint.textContent = PRICING_OK ? "Paqueter√≠a (precio actual)" : "Paqueter√≠a (estimado)";
        }

        updateSummary();
    }

    function fieldLabel(el) {
        if (el.id) {
            const lf = formEl.querySelector(`label[for="${el.id}"]`);
            if (lf) return lf.textContent.trim();
        }
        const wrap = el.closest('[class*="col-"]');
        const l2 = wrap?.querySelector("label.form-label");
        if (l2) return l2.textContent.trim();
        return el.placeholder || el.name || "este campo";
    }

    function messageForInvalid(el) {
        const name = fieldLabel(el);
        if (el.id === "phone" && el.validity.patternMismatch) return `Revisa "${name}": deben ser 10 d√≠gitos.`;
        if (el.validity.valueMissing) return `Completa "${name}".`;
        if (el.validity.patternMismatch) return `Revisa "${name}" (formato inv√°lido).`;
        if (el.validity.typeMismatch) return `Revisa "${name}".`;
        return `Revisa "${name}".`;
    }

    function getOrCreateFeedback(el) {
        const next = el.nextElementSibling;
        if (next && next.classList?.contains("invalid-feedback")) return next;

        const fb = document.createElement("div");
        fb.className = "invalid-feedback";
        fb.setAttribute("data-generated", "1");
        el.insertAdjacentElement("afterend", fb);
        return fb;
    }

    function markInvalid(el) {
        const msg = messageForInvalid(el);
        const fb = getOrCreateFeedback(el);
        if (fb) fb.textContent = msg;
        el.classList.add("is-invalid");
    }

    function clearInvalid(el) {
        el.classList.remove("is-invalid");
        const next = el.nextElementSibling;
        if (next && next.classList?.contains("invalid-feedback") && next.getAttribute("data-generated") === "1") {
            next.remove();
        }
    }

    function showDepartTimeError(msg) {
        if (!departTimeError) return;
        departTimeError.textContent = msg || "Selecciona un horario disponible.";
        departTimeError.classList.remove("d-none");
    }

    function clearDepartTimeError() {
        if (!departTimeError) return;
        departTimeError.textContent = "";
        departTimeError.classList.add("d-none");
    }

    function routeLabel(dir) {
        return dir === "VIC_TO_LLE" ? "Victoria ‚Üí Llera" : "Llera ‚Üí Victoria";
    }

    function paymentLabel(v) {
        if (v === "TAQUILLA") return "Taquilla";
        if (v === "TRANSFERENCIA") return "Transferencia";
        if (v === "ONLINE") return "Pago en linea";
        return "-";
    }

    function updateSummary() {
        const sumRoute = document.getElementById("sumRoute");
        const sumDate = document.getElementById("sumDate");
        const sumTime = document.getElementById("sumTime");
        const sumType = document.getElementById("sumType");
        const sumSeats = document.getElementById("sumSeats");
        const sumPayment = document.getElementById("sumPayment");
        const sumTotal = document.getElementById("sumTotal");
        const sumContact = document.getElementById("sumContact");

        if (!sumRoute) return;

        const isPassenger = typeSel.value === "PASSENGER";
        sumRoute.textContent = routeLabel(directionInput.value || "");
        sumDate.textContent = tripDate.value || "-";
        sumTime.textContent = departTimeHidden.value || "Sin seleccionar";
        sumType.textContent = isPassenger ? "Pasajero" : "Paqueteria";
        sumSeats.textContent = isPassenger ? String(seatsSel.value || "1") : "N/A";
        sumPayment.textContent = paymentLabel(paymentMethod.value);
        sumTotal.textContent = priceTotal.textContent || "-";
        sumContact.textContent = (customerName.value || "").trim() || "-";
    }

    function updateWizardUI() {
        for (const dot of stepDots) {
            const step = Number(dot.dataset.stepTarget || "1");
            dot.classList.toggle("is-active", step === currentStep);
            dot.classList.toggle("is-done", step < currentStep);
        }

        for (const panel of stepPanels) {
            panel.classList.toggle("is-active", Number(panel.dataset.step || "1") === currentStep);
        }

        if (wizardBar) {
            const pct = (currentStep / TOTAL_STEPS) * 100;
            wizardBar.style.width = `${pct}%`;
        }

        updateSummary();
    }

    function focusFirstFieldInStep(step) {
        const panel = stepPanels.find((x) => Number(x.dataset.step || "1") === step);
        if (!panel) return;
        const first = panel.querySelector("input:not([type=\"hidden\"]), select, textarea, button[data-next-step], button[data-prev-step]");
        if (first && typeof first.focus === "function") first.focus();
    }

    function validateStep(step) {
        const panel = stepPanels.find((x) => Number(x.dataset.step || "1") === step);
        if (!panel) return true;

        const invalids = [];
        const requiredInStep = [...panel.querySelectorAll("input, select, textarea")].filter((el) => {
            if (!el.required) return false;
            if (el.disabled) return false;
            if (el.type === "hidden") return false;
            if (el.closest(".d-none")) return false;
            if (el.offsetParent === null) return false;
            return true;
        });

        for (const el of requiredInStep) {
            if (!el.checkValidity()) invalids.push(el);
        }

        if (step === 1 && !departTimeHidden.value) {
            showDepartTimeError("Selecciona un horario disponible antes de continuar.");
            document.getElementById("sections")?.closest(".slots-wrap")?.scrollIntoView({
                behavior: "smooth",
                block: "center"
            });
            return false;
        }

        if (invalids.length) {
            invalids.forEach(markInvalid);
            const first = invalids[0];
            first.focus({preventScroll: true});
            first.scrollIntoView({behavior: "smooth", block: "center"});
            return false;
        }

        return true;
    }

    function goToStep(step, force = false) {
        const target = Math.max(1, Math.min(TOTAL_STEPS, Number(step || 1)));
        if (!force && target > maxReachedStep + 1) return;
        currentStep = target;
        maxReachedStep = Math.max(maxReachedStep, currentStep);
        updateWizardUI();
        writeDraft();
    }

    function goNextStep() {
        if (!validateStep(currentStep)) return;
        goToStep(currentStep + 1, true);
        focusFirstFieldInStep(currentStep);
    }

    function goPrevStep() {
        goToStep(currentStep - 1, true);
        focusFirstFieldInStep(currentStep);
    }

    formEl.addEventListener("input", (e) => {
        clearInvalid(e.target);
        writeDraft();
    }, true);
    formEl.addEventListener("change", (e) => {
        clearInvalid(e.target);
        writeDraft();
    }, true);

    formEl.addEventListener("click", (e) => {
        const nextBtn = e.target.closest("[data-next-step]");
        if (nextBtn) {
            e.preventDefault();
            goNextStep();
            return;
        }

        const prevBtn = e.target.closest("[data-prev-step]");
        if (prevBtn) {
            e.preventDefault();
            goPrevStep();
        }
    });

    stepDots.forEach((dot) => {
        dot.addEventListener("click", () => {
            const target = Number(dot.dataset.stepTarget || "1");
            if (target <= currentStep) {
                goToStep(target, true);
                return;
            }

            if (target === currentStep + 1 && validateStep(currentStep)) {
                goToStep(target, true);
            }
        });
    });

    formEl.addEventListener("submit", (e) => {
        if (currentStep < TOTAL_STEPS) {
            e.preventDefault();
            if (validateStep(currentStep)) goToStep(currentStep + 1, true);
            return;
        }

        const invalid = formEl.querySelector(":invalid");
        if (invalid) {
            e.preventDefault();
            [...formEl.querySelectorAll(":invalid")].forEach(markInvalid);

            const panel = invalid.closest(".form-step");
            const step = Number(panel?.dataset.step || "1");
            goToStep(step, true);

            invalid.focus({preventScroll: true});
            invalid.scrollIntoView({behavior: "smooth", block: "center"});
            return;
        }

        if (!departTimeHidden.value) {
            e.preventDefault();
            goToStep(1, true);
            showDepartTimeError("Selecciona un horario disponible antes de confirmar.");
            document.getElementById("sections")?.closest(".slots-wrap")?.scrollIntoView({
                behavior: "smooth",
                block: "center"
            });
            return;
        }

        clearDraft();
    });

    fromCity.addEventListener("change", () => {
        syncDirection();
        loadAvailability();
    });
    toCity.addEventListener("change", () => {
        syncDirection();
        loadAvailability();
    });

    tripDate.addEventListener("change", () => {
        updateSummary();
        loadAvailability();
    });

    typeSel.addEventListener("change", () => {
        updateUIByType();
        loadAvailability();
    });

    namesToggle?.addEventListener("change", () => {
        renderPassengerInputs();
        writeDraft();
    });

    customerName?.addEventListener("input", () => {
        updateSummary();
        writeDraft();
    });

    plusBtn.addEventListener("click", () => {
        setSeats(Number(seatsSel.value || 1) + 1);
        renderPassengerInputs();
        loadAvailability();
    });

    minusBtn.addEventListener("click", () => {
        setSeats(Number(seatsSel.value || 1) - 1);
        renderPassengerInputs();
        loadAvailability();
    });

    paymentMethod.addEventListener("change", updateUIByPayment);

    // ‚úÖ I restore local draft first, then query params can override when present
    restoreDraft();

    // ‚úÖ I apply query prefill before syncing direction and loading availability
    applyPrefillFromQuery();

    goToStep(restoredStep || 1, true);
    syncDirection();
    updateUIByType();
    updateUIByPayment();

    if (!tripDate.value) tripDate.value = todayISO();

    setSeats(Number(seatsSel.value || 1));
    renderPassengerInputs();

    // ‚úÖ pintar precio inmediato con lo que vino del server
    updatePriceUI();

    // ‚úÖ refrescar pricing desde DB (por si cambi√≥)
    loadPricing();

    // horarios
    loadAvailability();
    updateSummary();
</script>

</body>
</html>
