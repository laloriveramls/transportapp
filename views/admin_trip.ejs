<!doctype html>
<html lang="es" data-theme="light">
<head>
    <%- include('partials/head') %>
    <link href="/css/theme.css" rel="stylesheet">
    <title>Salida</title>

    <style>
        .page-title{ letter-spacing:-.02em; font-weight:800; margin:0; }

        .pill{
            display:inline-flex; align-items:center; gap:.45rem;
            padding:.42rem .7rem;
            border-radius:999px;
            border:1px solid var(--border);
            background:var(--chip-bg);
            color:var(--chip-text);
            font-weight:700;
            font-size:.9rem;
            white-space:nowrap;
        }

        .trip-card{
            background:var(--card);
            border:1px solid var(--border);
            box-shadow:var(--shadow);
            border-radius:20px;
            overflow:hidden;
        }
        .trip-card .top{ padding:16px 16px 12px; }
        .trip-card .bottom{
            padding:12px 16px 16px;
            border-top:1px solid var(--border);
            background:color-mix(in srgb, var(--card) 88%, transparent);
        }

        .progress-soft{
            height:10px; border-radius:999px;
            background:color-mix(in srgb, var(--muted) 18%, transparent);
            overflow:hidden; border:1px solid var(--border);
        }
        .progress-soft > span{
            display:block; height:100%;
            width:var(--w,0%);
            background:linear-gradient(90deg, var(--wine), var(--wine-2));
            border-radius:999px;
        }

        .card-soft{
            background:var(--card);
            border:1px solid var(--border);
            box-shadow:var(--shadow);
            border-radius:20px;
            overflow:hidden;
        }

        .table-wrap-pad{ padding:10px 12px; }

        .table-pro{ --bs-table-bg:transparent; border-color:var(--border); }
        .table-pro thead th{
            font-size:.85rem; color:var(--muted);
            font-weight:700;
            border-bottom:1px solid var(--border);
            white-space:nowrap;
        }
        .table-pro td{
            vertical-align:middle;
            border-bottom:1px solid var(--border);
            color:var(--text);
        }
        .table-pro thead th, .table-pro tbody td{
            padding:.75rem .9rem !important;
        }

        @media (max-width: 576px) {
            .table-pro thead th, .table-pro tbody td{
                padding:.65rem .7rem !important;
            }

            /* en mobile: el thead no tiene sentido porque usamos cards */
            .table-pro thead {
                display: none;
            }
        }

        .table-pro thead th:first-child, .table-pro tbody td:first-child{ padding-left:1.1rem !important; }
        .table-pro thead th:last-child,  .table-pro tbody td:last-child{  padding-right:1.1rem !important; }

        .td-wrap{ max-width:360px; word-break:break-word; }

        .badge-soft{
            border:1px solid var(--border);
            padding:.33rem .55rem;
            border-radius:999px;
            font-weight:700;
            font-size:.82rem;
            display:inline-flex;
            align-items:center;
            gap:.4rem;
            white-space:nowrap;
        }
        .badge-paid{ background:rgba(16,216,143,.12); color:color-mix(in srgb, #10D88F 70%, var(--text)); }
        .badge-pending{ background:rgba(241,220,33,.14); color:color-mix(in srgb, #f1dc21 60%, var(--text)); }
        .badge-cancel{ background:rgba(148,163,184,.18); color:var(--muted); }

        .btn-xs{
            padding:.35rem .55rem;
            border-radius:12px;
            font-weight:700;
            font-size:.82rem;
            line-height:1.1;
            display:inline-flex;
            align-items:center;
            gap:.35rem;
        }

        .btn-ghost{
            border:1px solid var(--border);
            background:transparent;
            color:var(--text);
        }
        .btn-ghost:hover{
            border-color:color-mix(in srgb, var(--wine) 40%, var(--border));
            background:color-mix(in srgb, var(--card) 70%, transparent);
            color:var(--text);
        }

        .btn-wa{ background:#25D366; border-color:#25D366; color:#fff; }
        .btn-wa:hover{ background:#1fb85a; border-color:#1fb85a; color:#fff; }

        .btn-pdf{
            border:1px solid color-mix(in srgb, var(--wine) 40%, var(--border));
            background:color-mix(in srgb, var(--wine) 12%, transparent);
            color:var(--text);
        }
        .btn-pdf:hover{
            border-color:var(--wine);
            background:color-mix(in srgb, var(--wine) 18%, transparent);
            color:var(--text);
        }

        .actions{
            display:flex;
            justify-content:flex-end;
            gap:.4rem;
            flex-wrap:wrap;
        }

        .subtle{ color:var(--muted); }
        .table-pro tbody tr:hover{ background:color-mix(in srgb, var(--card) 80%, var(--wine) 4%); }

        .ticket-code{
            font-weight:800;
            letter-spacing:.02em;
            color:var(--wine);
            text-decoration:none;
        }
        .ticket-code:hover{ text-decoration:underline; }

        .tr-mobile {
            display: none;
        }

        /* desktop: escondo mobile row */

        @media (max-width: 576px) {
            .app-navbar .navbar-brand .fw-bold {
                font-size: .95rem;
            }
            .theme-btn{ padding:.35rem .55rem; border-radius:12px; }

            .trip-card .top{ padding:14px 14px 10px; }
            .trip-card .bottom{ padding:10px 14px 14px; }
            .pill{ font-size:.88rem; }
            .page-title{ font-size:1.15rem; line-height:1.2; }
            .trip-card .top .text-end{ text-align:left !important; }

            .tr-desktop{ display:none; }
            .tr-mobile{ display:table-row; }

            .tr-mobile td {
                padding: 0 !important;
                border: 0 !important;
            }

            .m-card{
                background:var(--card);
                border:1px solid var(--border);
                border-radius:16px;
                box-shadow:var(--shadow);
                overflow:hidden;
                margin:10px 0;
                padding:10px 12px;
            }

            .m-row-top{
                display:flex;
                justify-content:space-between;
                align-items:flex-start;
                gap:10px;
            }
            .m-name{
                font-weight:800;
                font-size:.98rem;
                line-height:1.2;
            }
            .m-meta{
                color:var(--muted);
                font-size:.85rem;
                margin-top:2px;
            }

            .m-divider{
                border-top:1px dashed color-mix(in srgb, var(--border) 75%, transparent);
                margin:8px 0;
            }

            .m-detail{ color:var(--text); font-size:.9rem; }
            .m-detail .subtle{ font-size:.85rem; }

            .m-ticket-row{
                display:flex;
                gap:8px;
                flex-wrap:wrap;
                align-items:center;
            }
            .m-ticket-row .btn-wa{ width:100%; justify-content:center; }

            .actions{
                justify-content:flex-start;
                display:grid;
                grid-template-columns: 1fr 1fr;
                gap:8px;
            }
            .actions > *{ width:100%; }
            .btn-xs{
                width:100%;
                justify-content:center;
                padding:.52rem .6rem;
                border-radius:14px;
            }

            .table-wrap-pad {
                padding: 6px 8px;
            }
        }
    </style>
</head>

<body>
<nav class="navbar navbar-dark app-navbar">
    <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/admin/agenda?date=<%= trip.trip_date %>">
            <span class="brand-dot"></span>
            <span class="fw-bold">‚Üê Agenda</span>
        </a>

        <div class="d-flex align-items-center gap-2">
            <button id="themeToggle" class="theme-btn" type="button" aria-label="Cambiar tema">
                <span id="themeIcon">üåô</span> <span class="d-none d-sm-inline">Tema</span>
            </button>

            <form method="POST" action="/admin/logout" class="m-0">
                <button class="btn btn-sm btn-outline-light rounded-4">Salir</button>
            </form>
        </div>
    </div>
</nav>

<main class="container py-4">
    <%
    const isActive = (x) => x.status !== 'CANCELLED';

    const countPassengers = (x) => {
        const byCount = Number(x.passenger_count || 0);
        const seats = Number(x.seats || 0);
        return byCount || seats || 1;
    };

    const usedRaw = (reservations || [])
            .filter(x => x.type === 'PASSENGER' && isActive(x))
            .reduce((acc, x) => acc + countPassengers(x), 0);

    const capRaw = Number(trip.capacity_passengers || 0);
    const cap = Math.min(6, Math.max(0, capRaw));
    const used = Math.min(usedRaw, cap);

    const pct = cap > 0 ? Math.min(100, Math.round((used / cap) * 100)) : 0;
    const libres = Math.max(0, cap - used);

    const mandados = (reservations || [])
            .filter(x => x.type === 'PACKAGE' && isActive(x))
            .reduce((acc, x) => acc + (Number(x.seats || 0) || 1), 0);

    function pmLabelOf(v) {
        const pm = String(v || '').toUpperCase();
        return pm === 'ONLINE' ? 'üí≥ Online'
                : pm === 'TRANSFERENCIA' ? 'üè¶ Transfer'
                        : pm === 'TAQUILLA' ? 'üíµ Taquilla'
                                : (v || '-');
    }
    %>

    <div class="trip-card mb-3">
        <div class="top">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
                <div>
                    <div class="pill">üöå Salida</div>
                    <h1 class="h3 page-title mt-2">
                        <%= directionLabel(trip.direction) %> ‚Äî
                        <span style="color: var(--wine);"><%= trip.depart_time %></span>
                    </h1>
                    <div class="subtle">Fecha: <%= trip.trip_date %></div>
                </div>

                <div class="text-end">
                    <div class="pill">üßç‚Äç‚ôÇÔ∏è <%= used %>/<%= cap %> ¬∑ <%= libres %> libres</div>
                    <div class="pill mt-2">üì¶ Paqueter√≠a: <%= mandados %></div>

                    <a class="btn btn-sm <%= onlyPending ? 'btn-wine' : 'btn-ghost' %> rounded-4 mt-2"
                       href="/admin/trip/<%= trip.trip_id %>?onlyPending=<%= onlyPending ? 0 : 1 %>">
                        <%= onlyPending ? 'Ver todos' : 'Solo pendientes' %>
                    </a>
                </div>
            </div>

            <div class="mt-3">
                <div class="d-flex justify-content-between small subtle mb-1">
                    <span>Ocupaci√≥n</span>
                    <span><%= pct %>%</span>
                </div>
                <div class="progress-soft" style="--w:<%= pct %>%"><span></span></div>
            </div>
        </div>

        <div class="bottom">
            <div class="subtle small">
                Marcar pagos, abrir ticket, descargar PDF, enviar por WhatsApp y cancelar reservaciones.
            </div>
        </div>
    </div>

    <div class="card-soft p-0">
        <div class="table-wrap-pad">
            <div class="table-responsive">
                <table class="table table-sm table-pro align-middle mb-0">
                    <thead>
                    <tr>
                        <th>Contacto</th>
                        <th>Tel</th>
                        <th>Tipo</th>
                        <th class="td-wrap">Detalle</th>
                        <th>M√©todo</th>
                        <th>Estado</th>
                        <th>Ticket</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                    </thead>

                    <tbody>
                    <% if (!reservations || reservations.length === 0) { %>
                        <tr>
                            <td colspan="8" class="p-4">
                                <div class="h6 mb-1">Sin reservaciones</div>
                                <div class="subtle">A√∫n no hay registros para esta salida.</div>
                            </td>
                        </tr>
                    <% } %>

                    <% (reservations || []).forEach(r => { %>
                        <%
                            const shown = (Number(r.passenger_count || 0) || Number(r.seats || 0) || 1);
                            const rawNames = String(r.passenger_names || '').trim();
                            const displayNames = rawNames ? rawNames : Array.from({ length: shown }, (_, i) => `Pasajero ${i + 1}`).join(', ');
                            const digits = (r.phone || '').replace(/\D/g, '');

                            const stU = String(r.status || '').toUpperCase();
                            const pmU = String(r.payment_method || '').toUpperCase();
                            const isPaid = stU === 'PAID';
                            const isPaidOnline = isPaid && pmU === 'ONLINE';
                        %>

                        <!-- =========================
                             DESKTOP ROW (normal)
                        ========================== -->
                        <tr class="tr-desktop">
                            <td><%= r.customer_name %></td>
                            <td class="subtle"><%= r.phone %></td>

                            <td>
                                <span class="pill">
                                  <%= r.type === "PASSENGER" ? "üßç‚Äç‚ôÇÔ∏è Pasajero" : "üì¶ Paqueter√≠a" %>
                                </span>
                            </td>

                            <td class="td-wrap">
                                <% if (r.type === "PASSENGER") { %>
                                    <div class="small">
                                        <div class="subtle"><%= shown %> pasajero(s)</div>
                                        <div class="subtle"><%= displayNames %></div>
                                    </div>
                                <% } else { %>
                                    <div class="small subtle"><div><%= r.package_details || "-" %></div></div>
                                <% } %>
                            </td>

                            <td>
                                <span class="badge-soft" style="background: rgba(148,163,184,.12); color: var(--text);">
                                  <%= pmLabelOf(r.payment_method) %>
                                </span>
                            </td>

                            <td>
                                <% if (stU === 'PAID') { %>
                                    <span class="badge-soft badge-paid">‚úÖ Pagado</span>
                                <% } else if (stU === 'CANCELLED') { %>
                                    <span class="badge-soft badge-cancel">‚õî Cancelado</span>
                                <% } else if (stU === 'PENDING_PAYMENT') { %>
                                    <span class="badge-soft badge-pending">‚è≥ Pendiente</span>
                                <% } else if (stU === 'PAY_AT_BOARDING') { %>
                                    <span class="badge-soft"
                                          style="background: rgba(59,130,246,.12); color: color-mix(in srgb, #3b82f6 70%, var(--text));">
                                        üíµ Pagar en taquilla
                                    </span>
                                <% } else { %>
                                    <span class="badge-soft" style="background: transparent; color: var(--muted);">
                                        <%= r.status %>
                                    </span>
                                <% } %>
                            </td>

                            <td>
                                <% if (r.ticket_code) { %>
                                    <a class="ticket-code" href="/ticket/<%= r.ticket_code %>" target="_blank"><%= r.ticket_code %></a>

                                    <% if (digits.length >= 10) { %>
                                        <div class="mt-2">
                                            <a class="btn btn-wa btn-xs" target="_blank"
                                               href="https://wa.me/52<%= digits %>?text=<%= encodeURIComponent(
                                                       'Tu ticket est√° listo\n' + (baseUrl || 'http://localhost:3000') + '/ticket/' + r.ticket_code
                                               ) %>">
                                                üí¨ WhatsApp
                                            </a>
                                        </div>
                                    <% } %>
                                <% } else { %>
                                    <span class="subtle">-</span>
                                <% } %>
                            </td>

                            <td class="text-end">
                                <div class="actions">

                                    <% if (!r.ticket_code && stU !== 'CANCELLED') { %>
                                        <form method="POST" action="/admin/reservation/<%= r.id %>/mark-paid" class="m-0">
                                            <input type="hidden" name="method" value="CASH">
                                            <button class="btn btn-wine btn-xs" type="submit">üíµ Efectivo</button>
                                        </form>

                                        <form method="POST" action="/admin/reservation/<%= r.id %>/mark-paid" class="m-0">
                                            <input type="hidden" name="method" value="TRANSFER">
                                            <button class="btn btn-ghost btn-xs" type="submit">üè¶ Transfer</button>
                                        </form>
                                    <% } %>

                                    <% if (r.ticket_code) { %>
                                        <a class="btn btn-ghost btn-xs" href="/ticket/<%= r.ticket_code %>" target="_blank">üëÅÔ∏è Ver</a>
                                        <a class="btn btn-pdf btn-xs" href="/ticket/<%= r.ticket_code %>/pdf" target="_blank" rel="noopener">üìÑ Ticket</a>
                                    <% } %>

                                        <!-- ‚úÖ ONLINE + PAID => 1) Cancelar  2) Stripe  3) Ya reembols√© -->
                                        <% if (stU !== 'CANCELLED' && isPaidOnline) { %>

                                            <!-- 1) Cancelar (con confirmaci√≥n) -->
                                            <!-- NOTA: tu backend /cancel en ONLINE+PAID NO cancela; solo redirige a Stripe -->
                                            <form method="POST" action="/admin/reservation/<%= r.id %>/cancel"
                                                  class="m-0"
                                                  onsubmit="return confirm('Esta reserva fue pagada en l√≠nea. Te llevar√© a Stripe para reembolsar. Despu√©s regresa y presiona ‚ÄúYa reembols√©‚Äù. ¬øContinuar?')">
                                                <button class="btn btn-outline-danger btn-xs" type="submit">‚õî Cancelar
                                                </button>
                                            </form>

                                            <!-- 2) Reembolsar (Stripe) -->
                                            <a class="btn btn-outline-danger btn-xs"
                                               href="/admin/reservation/<%= r.id %>/stripe-refund"
                                               target="_blank" rel="noopener">
                                                ‚Ü©Ô∏è Reembolsar (Stripe)
                                            </a>

                                            <!-- 3) Ya reembols√© (con confirmaci√≥n) -->
                                            <form method="POST" action="/admin/reservation/<%= r.id %>/refund-done"
                                                  class="m-0"
                                                  onsubmit="return confirm('¬øConfirmas que YA hiciste el reembolso en Stripe? Esto marcar√° la reserva como CANCELLED y libera cupo.')">
                                                <button class="btn btn-ghost btn-xs" type="submit">‚úÖ Ya reembols√©
                                                </button>
                                            </form>

                                        <% } else if (stU !== 'CANCELLED' && !isPaid) { %>

                                        <!-- No pagado => cancelar normal -->
                                        <form method="POST" action="/admin/reservation/<%= r.id %>/cancel" class="m-0"
                                              onsubmit="return confirm('¬øCancelar esta reserva? Esto libera cupo.')">
                                            <button class="btn btn-outline-danger btn-xs" type="submit">‚õî Cancelar</button>
                                        </form>

                                    <% } %>
                                </div>
                            </td>
                        </tr>

                        <!-- =========================
                             MOBILE ROW (card)
                        ========================== -->
                        <tr class="tr-mobile">
                            <td colspan="8">
                                <div class="m-card">
                                    <div class="m-row-top">
                                        <div>
                                            <div class="m-name"><%= r.customer_name %></div>
                                            <div class="m-meta">
                                                <%= r.phone %> ¬∑ <%= r.type === "PASSENGER" ? "üßç‚Äç‚ôÇÔ∏è Pasajero" : "üì¶ Paqueter√≠a" %>
                                            </div>
                                        </div>

                                        <div style="text-align:right;">
                                            <% if (stU === 'PAID') { %>
                                                <span class="badge-soft badge-paid">‚úÖ Pagado</span>
                                            <% } else if (stU === 'CANCELLED') { %>
                                                <span class="badge-soft badge-cancel">‚õî Cancelado</span>
                                            <% } else if (stU === 'PENDING_PAYMENT') { %>
                                                <span class="badge-soft badge-pending">‚è≥ Pendiente</span>
                                            <% } else if (stU === 'PAY_AT_BOARDING') { %>
                                                <span class="badge-soft"
                                                      style="background: rgba(59,130,246,.12); color: color-mix(in srgb, #3b82f6 70%, var(--text));">
                                                    üíµ Taquilla
                                                </span>
                                            <% } else { %>
                                                <span class="badge-soft" style="background: transparent; color: var(--muted);">
                                                    <%= r.status %>
                                                </span>
                                            <% } %>

                                            <div class="mt-2">
                                                <span class="badge-soft"
                                                      style="background: rgba(148,163,184,.12); color: var(--text);">
                                                    <%= pmLabelOf(r.payment_method) %>
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="m-divider"></div>

                                    <div class="m-detail">
                                        <% if (r.type === "PASSENGER") { %>
                                            <div class="subtle"><%= shown %> pasajero(s)</div>
                                            <div class="subtle"><%= displayNames %></div>
                                        <% } else { %>
                                            <div class="subtle"><%= r.package_details || "-" %></div>
                                        <% } %>
                                    </div>

                                    <div class="m-divider"></div>

                                    <div class="m-ticket-row">
                                        <% if (r.ticket_code) { %>
                                            <a class="ticket-code" href="/ticket/<%= r.ticket_code %>" target="_blank"><%= r.ticket_code %></a>

                                            <% if (digits.length >= 10) { %>
                                                <a class="btn btn-wa btn-xs" target="_blank"
                                                   href="https://wa.me/52<%= digits %>?text=<%= encodeURIComponent(
                                                           'Tu ticket est√° listo\n' + (baseUrl || 'http://localhost:3000') + '/ticket/' + r.ticket_code
                                                   ) %>">üí¨ WhatsApp</a>
                                            <% } %>
                                        <% } else { %>
                                            <span class="subtle">Sin ticket</span>
                                        <% } %>
                                    </div>

                                    <div class="m-divider"></div>

                                    <div class="actions">
                                        <% if (!r.ticket_code && stU !== 'CANCELLED') { %>
                                            <form method="POST" action="/admin/reservation/<%= r.id %>/mark-paid" class="m-0">
                                                <input type="hidden" name="method" value="CASH">
                                                <button class="btn btn-wine btn-xs" type="submit">üíµ Efectivo</button>
                                            </form>

                                            <form method="POST" action="/admin/reservation/<%= r.id %>/mark-paid" class="m-0">
                                                <input type="hidden" name="method" value="TRANSFER">
                                                <button class="btn btn-ghost btn-xs" type="submit">üè¶ Transfer</button>
                                            </form>
                                        <% } %>

                                        <% if (r.ticket_code) { %>
                                            <a class="btn btn-ghost btn-xs" href="/ticket/<%= r.ticket_code %>" target="_blank">üëÅÔ∏è Ver</a>
                                            <a class="btn btn-pdf btn-xs" href="/ticket/<%= r.ticket_code %>/pdf" target="_blank" rel="noopener">üìÑ PDF</a>
                                        <% } %>

                                            <!-- ‚úÖ ONLINE + PAID => 1) Cancelar  2) Stripe  3) Ya reembols√© -->
                                            <% if (stU !== 'CANCELLED' && isPaidOnline) { %>

                                                <!-- 1) Cancelar -->
                                                <form method="POST" action="/admin/reservation/<%= r.id %>/cancel"
                                                      class="m-0"
                                                      onsubmit="return confirm('Esta reserva fue pagada en l√≠nea. Te llevar√© a Stripe para reembolsar. Despu√©s regresa y presiona ‚ÄúYa reembols√©‚Äù. ¬øContinuar?')">
                                                    <button class="btn btn-outline-danger btn-xs" type="submit">‚õî
                                                        Cancelar
                                                    </button>
                                                </form>

                                                <!-- 2) Stripe -->
                                                <a class="btn btn-outline-danger btn-xs"
                                                   href="/admin/reservation/<%= r.id %>/stripe-refund"
                                                   target="_blank" rel="noopener">
                                                    ‚Ü©Ô∏è Reembolsar (Stripe)
                                                </a>

                                                <!-- 3) Ya reembols√© -->
                                                <form method="POST" action="/admin/reservation/<%= r.id %>/refund-done"
                                                      class="m-0"
                                                      onsubmit="return confirm('¬øConfirmas que YA hiciste el reembolso en Stripe? Esto marcar√° la reserva como CANCELLED y libera cupo.')">
                                                    <button class="btn btn-ghost btn-xs" type="submit">‚úÖ Ya reembols√©
                                                    </button>
                                                </form>

                                            <% } else if (stU !== 'CANCELLED' && !isPaid) { %>

                                            <form method="POST" action="/admin/reservation/<%= r.id %>/cancel" class="m-0"
                                                  onsubmit="return confirm('¬øCancelar esta reserva? Esto libera cupo.')">
                                                <button class="btn btn-outline-danger btn-xs" type="submit">‚õî Cancelar</button>
                                            </form>

                                        <% } %>
                                    </div>
                                </div>
                            </td>
                        </tr>

                    <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</main>

<script src="/js/theme.js"></script>
</body>
</html>
