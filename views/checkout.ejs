<!doctype html>
<html lang="es" data-theme="light">
<head>
    <%- include('partials/head') %>
    <title>Pago en l√≠nea</title>

    <style>
        .card-soft{
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            border-radius: 22px;
            overflow: hidden;
        }
        .top{
            padding: 18px 18px 14px;
            background:
                    radial-gradient(1000px 520px at 10% 0%, rgba(106,15,31,.20), transparent 55%),
                    radial-gradient(800px 420px at 90% 10%, rgba(106,15,31,.10), transparent 60%);
            border-bottom: 1px solid var(--border);
        }
        .body{ padding: 18px; }

        .title{ letter-spacing: -.02em; font-weight: 650; margin: 0; }
        .meta{ color: var(--muted); font-size: .95rem; }

        .pill{
            display:inline-flex; align-items:center; gap:.5rem;
            padding:.45rem .75rem; border-radius:999px;
            border:1px solid var(--border);
            background: var(--chip-bg);
            color: var(--chip-text);
            font-weight:600; font-size:.9rem;
            white-space:nowrap;
        }

        .kv{
            list-style:none; padding:0; margin:0;
            display:grid; gap:.55rem;
        }
        .kv li{
            display:flex; justify-content:space-between; gap:12px;
            padding:.6rem .75rem;
            border:1px solid var(--border);
            border-radius:14px;
            background: color-mix(in srgb, var(--card) 86%, transparent);
        }
        .kv .k{ color: var(--muted); font-weight:500; }
        .kv .v{ color: var(--text); font-weight:500; text-align:right; }

        .note{
            border:1px solid var(--border);
            background: color-mix(in srgb, var(--card) 82%, transparent);
            border-radius: 16px;
            padding: 12px 14px;
            color: var(--muted);
        }

        .mono{
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
            font-size: .95rem;
            color: var(--text);
            word-break: break-word;
        }

        .btn-xs{
            padding:.55rem .9rem;
            border-radius:12px;
            font-weight:600;
            font-size:.95rem;
        }
        .btn-ghost{
            border:1px solid var(--border);
            background:transparent;
            color: var(--text);
        }
        .btn-ghost:hover{
            border-color: color-mix(in srgb, var(--wine) 40%, var(--border));
            background: color-mix(in srgb, var(--card) 70%, transparent);
            color: var(--text);
        }

        .divider{ height:1px; background: var(--border); margin: 14px 0; }

        .danger{
            border-color: rgba(239,68,68,.35);
            background: rgba(239,68,68,.06);
            color: color-mix(in srgb, #ef4444 55%, var(--text));
        }

        .spinner{
            width:18px; height:18px;
            border:2px solid rgba(255,255,255,.35);
            border-top-color:#fff;
            border-radius:999px;
            display:inline-block;
            animation: spin .8s linear infinite;
            vertical-align: -3px;
            margin-right:8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>

<body>
<nav class="navbar navbar-dark app-navbar">
    <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/">
            <span class="brand-dot"></span>
            <span class="fw-semibold">TransportApp</span>
        </a>

        <button id="themeToggle" class="theme-btn" type="button" aria-label="Cambiar tema">
            <span id="themeIcon">üåô</span> <span class="d-none d-sm-inline">Tema</span>
        </button>
    </div>
</nav>

<main class="container py-4">

    <%
    // r viene del server: reserva + trip_date + depart_time + direction
    const type = String(r.type || "").toUpperCase();
    const isPassenger = type === "PASSENGER";
    const isPackage = type === "PACKAGE";

    const payment = String(r.payment_method || "ONLINE").toUpperCase();
    const status = String(r.status || "").toUpperCase();

    // I trust the server total, and I keep a safe fallback.
    const unit = Number(r.unit_price_mxn || 120);
    const seats = Number(r.seats || 0);
    const totalSafe =
            (total != null && total !== "")
                    ? Number(total)
                    : (isPassenger ? unit * Math.max(1, seats || 1) : unit);

    function fmtMXN(n){
        const v = Number(n || 0);
        return `$${v.toFixed(2)} MXN`;
    }

    function typeLabel(){
        return isPassenger ? "Pasaje" : "Paqueter√≠a";
    }

    function routeLabel(dir){
        return dir === "VIC_TO_LLE" ? "Victoria - Llera" : "Llera - Victoria";
    }

    const isOnline = payment === "ONLINE";
    const canPay = isOnline && (status === "PENDING_PAYMENT" || !status); // I allow old rows without status.
    const isPaid = status === "PAID";
    %>

    <div class="card-soft">
        <div class="top">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
                <div>
                    <div class="pill">Pago en l√≠nea</div>
                    <h1 class="h3 title mt-2">Checkout</h1>
                    <div class="meta mt-1">Revisa tus datos y confirma el pago.</div>
                </div>

                <div class="d-flex gap-2 flex-wrap">
                    <a class="btn btn-ghost btn-xs" href="/pay/<%= r.id %>">Volver</a>
                    <a class="btn btn-ghost btn-xs" href="/">Inicio</a>
                </div>
            </div>
        </div>

        <div class="body">

            <% if (!isOnline) { %>
                <div class="note danger mb-3">
                    Esta reserva no est√° configurada como <strong>Pago en l√≠nea</strong>.
                    Vuelve y cambia el m√©todo de pago si lo necesitas.
                </div>
            <% } %>

            <% if (isPaid) { %>
                <div class="note mb-3">
                    ‚úÖ Este pago ya aparece como <strong>Pagado</strong>. Si solo quer√≠as revisar, puedes volver.
                </div>
            <% } %>

            <ul class="kv mb-3">
                <li><span class="k">Folio</span><span class="v mono"><%= folio %></span></li>
                <li><span class="k">Tipo</span><span class="v"><%= typeLabel() %></span></li>

                <% if (isPassenger) { %>
                    <li><span class="k">Pasajeros</span><span class="v"><%= Math.max(1, Number(seats || 1)) %></span></li>
                <% } %>

                <% if (isPackage) { %>
                    <li><span class="k">Detalle</span><span class="v"><%= (r.package_details || "-") %></span></li>
                <% } %>

                <li><span class="k">Ruta</span><span class="v"><%= routeLabel(r.direction) %></span></li>
                <li><span class="k">Fecha</span><span class="v"><%= r.trip_date %></span></li>
                <li><span class="k">Hora</span><span class="v"><%= r.depart_time %></span></li>
                <li><span class="k">Contacto</span><span class="v"><%= r.customer_name %></span></li>
                <li><span class="k">Tel√©fono</span><span class="v"><%= r.phone %></span></li>

                <li><span class="k">Total a pagar</span><span class="v"><strong><%= fmtMXN(totalSafe) %></strong></span></li>
            </ul>

            <div class="note mb-3">
                A√∫n no hay proveedor de pagos configurado. Este checkout es <strong>simulaci√≥n</strong>:
                al confirmar, registraremos el pago como completado (para pruebas) y te llevaremos al resumen.
            </div>

            <div class="divider"></div>

            <div class="d-flex gap-2 flex-wrap">
                <form id="payForm" method="POST" action="/checkout/<%= r.id %>/complete" class="m-0">
                    <input type="hidden" name="amount_total_mxn" value="<%= totalSafe %>">
                    <input type="hidden" name="currency" value="MXN">

                    <button id="payBtn" class="btn btn-wine btn-xs" type="submit"
                    <% if (!canPay || isPaid) { %> disabled <% } %>>
                        Pagar ahora (simulado)
                    </button>
                </form>

                <a class="btn btn-ghost btn-xs" href="/pay/<%= r.id %>">Ver resumen</a>
            </div>

            <div class="mt-3">
                <small class="text-muted">
                    Cuando conectemos Stripe/MercadoPago, este bot√≥n abrir√° el flujo real y luego regresar√° a
                    <span class="mono">/pay/<%= r.id %></span>.
                </small>
            </div>

        </div>
    </div>

</main>

<script src="/js/theme.js"></script>

<script>
    const form = document.getElementById("payForm");
    const btn = document.getElementById("payBtn");

    form?.addEventListener("submit", () => {
        // I block double-submit and I show a small loading hint.
        if (!btn) return;
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner"></span>Procesando...`;
    });
</script>
</body>
</html>
